<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Alert System</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/sos.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #fef2f2, #ffffff);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* Two-column layout container */
        .dashboard-container {
            display: flex;
            height: calc(100vh - 20px);
            overflow: hidden;
        }
        
        /* Left side - scrollable */
        .left-column {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem;
        }
        
        /* Right side - fixed */
        .right-column {
            width: 400px;
            position: sticky;
            top: 0;
            align-self: flex-start;
            height: calc(100vh - 20px);
            max-height: calc(100vh - 20px);
            overflow: hidden;
            border-left: 2px solid #e5e7eb;
            background: white;
            flex-shrink: 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .dashboard-container {
                flex-direction: column;
                height: auto;
            }
            
            .left-column {
                overflow-y: visible;
            }
            
            .right-column {
                width: 100%;
                position: relative;
                height: auto;
                border-left: none;
                border-top: 2px solid #e5e7eb;
            }
        }
        
        .alert-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-online { 
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        
        .status-alert { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
        
        .status-warning { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        
        .map-container {
            background: linear-gradient(135deg, #1e293b, #334155);
            border: 2px solid #475569;
        }
        
        .high-risk-label {
            background: transparent !important;
            border: none !important;
        }
        
        .high-risk-label div {
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .emergency-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .emergency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .emergency-card.PRIORITY{
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #ffffff);
        }
        
        .emergency-card.PENDING{
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb, #ffffff);
        }
        
        .emergency-card.RESOLVED{
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #ffffff);
        }
        
        .text-contrast {
            color: #1f2937;
        }
        
        .bg-content {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 200px;
            z-index: 50;
            margin-top: 0.5rem;
        }
        
        .profile-dropdown.show {
            display: block;
        }
        
        .profile-dropdown a {
            display: block;
            padding: 0.75rem 1rem;
            color: #374151;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .profile-dropdown a:hover {
            background-color: #f3f4f6;
        }
        
        .profile-dropdown .divider {
            border-top: 1px solid #e5e7eb;
            margin: 0.25rem 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            border: 5px solid #e5e7eb;
        }
        
        /* Remove ALL borders from inner modal content */
        #alertDetails *,
        #alertDetails,
        #alertDetails * * {
            border: none !important;
            border-color: transparent !important;
        }
        
        /* Category-specific border colors for modal - ONLY on outer container */
        .modal-content.border-red-900 {
            border-color: #7c2d12 !important;
        }
        
        .modal-content.border-red-600 {
            border-color: #dc2626 !important;
        }
        
        .modal-content.border-blue-900 {
            border-color: #1e3a8a !important;
        }
        
        .modal-content.border-yellow-500 {
            border-color: #eab308 !important;
        }
        
        .modal-content.border-gray-500 {
            border-color: #6b7280 !important;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95%;
                max-height: 95%;
                margin: 0.5rem;
                width: 95% !important;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .modal-header {
                padding: 1rem;
            }
            
            .modal-footer {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .modal-footer button {
                flex: 1 1 auto;
                min-width: calc(50% - 0.25rem);
            }
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .modal.show {
            display: flex;
        }
        
        .scrollable-alerts {
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        
        /* Chart Toggle Button Styles */
        .chart-toggle-btn {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            background-color: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0.25rem;
        }
        
        .chart-toggle-btn:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .chart-toggle-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }
        
        .chart-toggle-btn.active:hover {
            background-color: #2563eb;
            border-color: #1d4ed8;
        }
        
        /* Chart Container Visibility */
        .chart-container {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .chart-container.hidden {
            display: none;
        }
        
        /* Alerts Button Tooltip */
        .alerts-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 20px rgba(239, 68, 68, 0.3);
            z-index: 1000;
            min-width: 200px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            animation: tooltipFadeIn 0.3s ease;
        }
        
        .alerts-tooltip.show {
            display: block;
        }
        
        .alerts-tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            right: 20px;
            border: 8px solid transparent;
            border-bottom-color: #1f2937;
        }
        
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tooltip-header {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ef4444;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(239, 68, 68, 0.3);
            padding-bottom: 8px;
        }
        
        .tooltip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .tooltip-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tooltip-value {
            font-weight: 700;
            font-size: 14px;
        }
        
        .tooltip-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .tooltip-badge.active {
            background: #ef4444;
            color: white;
        }
        
        .tooltip-badge.pending {
            background: #f97316;
            color: white;
        }
        
        .scrollable-alerts::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-alerts::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .scrollable-alerts::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .scrollable-alerts::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Scrollable Recent Activity Styles */
        .scrollable-activity {
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        
        .scrollable-activity::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-activity::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .scrollable-activity::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .scrollable-activity::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .activity-item {
            transition: all 0.2s ease;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .activity-item:hover {
            background-color: #f8fafc;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        /* Admin Users Section - Same height */
        .admin-users-container {
            overflow-y: auto;
        }
        
        .admin-users-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .admin-users-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .admin-users-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .admin-users-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 1rem;
        }
        
        .info-card {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #3b82f6;
        }
        
        .medical-info {
            border-left-color: #ef4444;
            background: #f8fafc;
        }
        
        .emergency-contact {
            border-left-color: #f59e0b;
            background: #f8fafc;
        }
        
        /* Active marker flashing animation - using opacity and filter only to avoid transform conflicts */
        .active-marker-flash {
            animation: activeMarkerFlash 1.5s ease-in-out infinite;
        }
        
        @keyframes activeMarkerFlash {
            0%, 100% { 
                opacity: 1;
                filter: drop-shadow(0 0 8px rgba(255, 0, 0, 0.9)) brightness(1.1);
            }
            50% { 
                opacity: 0.85;
                filter: drop-shadow(0 0 20px rgba(255, 0, 0, 1)) brightness(1.3);
            }
        }
        
        /* Add a pulsing ring effect using a separate element that doesn't interfere with positioning */
        .leaflet-marker-pane .active-marker-flash {
            position: relative;
        }
        
        /* Create a pulsing ring effect using box-shadow on the marker container */
        .leaflet-marker-icon.active-marker-flash {
            position: relative;
        }
        
        /* Pulsing ring effect using box-shadow - no transform to avoid conflicts */
        .active-marker-flash::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1px;
            height: 1px;
            margin-left: -0.5px;
            margin-top: -0.5px;
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            animation: pulseRing 2s ease-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes pulseRing {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(255, 0, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }
        
        .auto-refresh-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 9999px;
            font-size: 12px;
            z-index: 1100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .auto-refresh-indicator {
                top: 80px;
                right: 10px;
                font-size: 11px;
                padding: 6px 10px;
            }
        }

        .auto-refresh-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Smooth transitions for list updates */
        .emergency-card,
        .activity-item {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Professional Leaflet Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            border: 1px solid #e5e7eb !important;
            font-family: 'Inter', sans-serif !important;
            padding: 0 !important;
            overflow: hidden !important;
            background: white !important;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            padding: 12px !important;
            font-size: 13px !important;
            line-height: 1.6 !important;
            min-width: 280px !important;
        }

        .leaflet-popup-tip {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            background: white !important;
        }

        .leaflet-popup-close-button {
            padding: 8px !important;
            font-size: 18px !important;
            color: #6b7280 !important;
            transition: color 0.2s ease !important;
            z-index: 10 !important;
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            text-align: center !important;
        }

        .leaflet-popup-close-button:hover {
            color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.1) !important;
            border-radius: 50% !important;
        }

        /* Prevent layout shift during updates */
        .scrollable-alerts,
        .scrollable-activity {
            will-change: contents;
        }

        /* Category Filter Buttons */
        .category-filter-btn {
            background: white;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
        }
        
        .category-filter-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .category-filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .category-filter-btn.urgent {
            border-color: #7c2d12;
            color: #7c2d12;
        }
        
        .category-filter-btn.urgent.active {
            background: #7c2d12;
            color: white;
        }
        
        .category-filter-btn.medical {
            border-color: #dc2626;
            color: #dc2626;
        }
        
        .category-filter-btn.medical.active {
            background: #dc2626;
            color: white;
        }
        
        .category-filter-btn.security {
            border-color: #1e3a8a;
            color: #1e3a8a;
        }
        
        .category-filter-btn.security.active {
            background: #1e3a8a;
            color: white;
        }
        
        .category-filter-btn.university {
            border-color: #eab308;
            color: #ca8a04;
        }
        
        .category-filter-btn.university.active {
            background: #eab308;
            color: white;
        }
        
        /* Map filter buttons */
        .map-filter-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }
        
        .filter-btn {
            background: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-width: 60px;
        }
        
        @media (min-width: 640px) {
            .filter-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 80px;
            }
        }
        
        .filter-btn:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }
        
        .filter-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        .filter-btn i {
            margin-right: 4px;
        }
        
        /* Pulse animation for re-center button */
        .filter-btn.pulse {
            animation: pulse-animation 0.6s ease-in-out;
        }
        
        @keyframes pulse-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Custom modal layout styles */
        .info-section {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            min-width: 0;
            overflow: hidden;
        }
        /* Thick gray outline for emphasized sections inside modal content.
           Uses inset box-shadow instead of border to bypass global border reset. */
        .section-emphasis {
            box-shadow: inset 0 0 0 1px #9ca3af; /* gray-400 */
            border-radius: 0.5rem;
        }
        
        .info-section h4 {
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }
        
        /* Timeline styles */
        .timeline {
            position: relative;
            padding-left: 2.5rem;
        }
        .timeline::before {
            content: "";
            position: absolute;
            left: 0.75rem;
            top: 0.25rem;
            bottom: 0.25rem;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-item {
            position: relative;
            padding: 0.5rem 0 0.5rem 0;
            padding-left: 0;
            color: #4b5563;
            min-height: 2.5rem;
        }
        .timeline-item .timeline-dot {
            position: absolute;
            left: -1.75rem;
            top: 0.75rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            background: #9ca3af; /* gray-400 */
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #e5e7eb;
            z-index: 1;
        }
        .timeline-item .timeline-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 1rem;
        }
        .timeline-item .timeline-label {
            flex: 1;
            white-space: nowrap;
            font-weight: inherit;
            line-height: 1.5;
        }
        .timeline-item .timeline-timestamp {
            font-size: 0.75rem;
            font-weight: normal;
            white-space: nowrap;
            flex-shrink: 0;
            text-align: right;
        }
        
        @media (max-width: 640px) {
            .timeline {
                padding-left: 2rem;
            }
            .timeline::before {
                left: 0.5rem;
            }
            .timeline-item .timeline-dot {
                left: -1.5rem;
            }
            .timeline-item .timeline-content {
                flex-wrap: wrap;
            }
            .timeline-item .timeline-label {
                font-size: 0.875rem;
            }
            .timeline-item .timeline-timestamp {
                font-size: 0.7rem;
                width: 100%;
                text-align: left;
                margin-top: 0.25rem;
            }
        }
        .timeline-item.active {
            color: #111827; /* gray-900 */
            font-weight: 600;
        }
        .timeline-item.active .timeline-dot {
            background: #10b981; /* emerald-500 */
            box-shadow: 0 0 0 2px #d1fae5; /* emerald-100 ring */
        }
        
        /* Timeline section specific adjustments */
        #timelineSection .timeline {
            padding-left: 2.5rem;
        }
        
        #timelineSection .timeline::before {
            left: 0.75rem;
        }
        
        #timelineSection .timeline-item {
            padding: 0.75rem 0;
            min-height: 2.75rem;
            display: flex;
            align-items: center;
        }
        
        #timelineSection .timeline-item .timeline-dot {
            left: -1.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.875rem;
            height: 0.875rem;
        }
        
        @media (max-width: 640px) {
            #timelineSection .timeline {
                padding-left: 2rem;
            }
            #timelineSection .timeline::before {
                left: 0.5rem;
            }
            #timelineSection .timeline-item .timeline-dot {
                left: -1.5rem;
                top: 50%;
                transform: translateY(-50%);
            }
        }
        
        .timeline-collapse {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.35s ease, opacity 0.25s ease;
        }
        
        .timeline-collapse.open {
            opacity: 1;
        }
        
        .detail-row {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        @media (min-width: 640px) {
            .detail-row {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
                gap: 1rem;
            }
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 500;
            color: #6b7280;
            flex-shrink: 0;
            min-width: fit-content;
            white-space: nowrap;
        }
        
        .detail-value {
            color: #1f2937;
            text-align: left;
            overflow-wrap: break-word;
            word-wrap: break-word;
            white-space: normal;
            min-width: 0;
            flex: 1;
            line-height: 1.5;
        }
        
        @media (min-width: 640px) {
            .detail-row {
                align-items: flex-start;
            }
            .detail-value {
                text-align: right;
                white-space: normal;
                overflow-wrap: break-word;
                word-wrap: break-word;
                max-width: 65%;
                min-width: 0;
                line-height: 1.5;
            }
        }
        
        /* Student information specific styles - always vertical */
        #studentInfoContent .detail-row,
        .info-section .detail-row {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        #studentInfoContent .detail-label,
        .info-section .detail-label {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            white-space: normal;
        }
        
        #studentInfoContent .detail-value,
        .info-section .detail-value {
            text-align: left;
            font-size: 0.9375rem;
        }
        
        @media (min-width: 640px) {
            #studentInfoContent .detail-row,
            .info-section .detail-row {
                flex-direction: column;
            }
            #studentInfoContent .detail-value,
            .info-section .detail-value {
                text-align: left;
                max-width: 100%;
            }
        }
        
        /* Line clamp utility for text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
            box-orient: vertical;
        }
        
        /* Mobile Hamburger Menu Styles */
        .hamburger-menu {
            display: none;
        }
        
        .mobile-nav {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .mobile-nav.show {
            transform: translateX(0);
        }
        
        @media (min-width: 769px) {
            .mobile-nav {
                display: none !important;
            }
        }
        
        .mobile-nav-content {
            padding: 2rem;
            height: 100%;
            overflow-y: auto;
        }
        
        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #374151;
        }
        
        .mobile-nav-item {
            display: block;
            padding: 1rem;
            color: white;
            text-decoration: none;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            background-color: #3b82f6;
        }
        
        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }
            
            .desktop-nav {
                display: none !important;
            }
            
            .header-title h1 {
                font-size: 1rem;
            }
            
            .header-title p {
                font-size: 0.75rem;
            }
            
            .header-logos img {
                height: 2.5rem;
                width: 2.5rem;
            }
            
            .map-container {
                height: 400px !important;
            }
            
            .scrollable-alerts {
                max-height: 300px !important;
            }
        }
    </style>
</head>
<body data-admin-name="{{ (session.admin_name or session.get('admin_name') or 'Administrator')|e }}"
      data-admin-id="{{ (session.admin_id or session.get('admin_id') or '')|e }}">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if category == 'success' %}
                <div class="fixed top-4 right-4 bg-white border-l-4 border-green-500 text-gray-800 px-4 py-3 rounded-lg z-50 shadow-lg transition-all duration-300 ease-in-out" id="flashMessage{{ loop.index }}" style="animation: slideInRight 0.3s ease-out;">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2 text-lg text-green-500"></i>
                        <span class="font-medium">{{ message }}</span>
                    </div>
                </div>
                {% elif category == 'error' %}
                <div class="fixed top-4 right-4 bg-white border-l-4 border-red-500 text-gray-800 px-4 py-3 rounded-lg z-50 shadow-lg transition-all duration-300 ease-in-out" id="flashMessage{{ loop.index }}" style="animation: slideInRight 0.3s ease-out;">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-2 text-lg text-red-500"></i>
                        <span class="font-medium">{{ message }}</span>
                    </div>
                </div>
                {% elif category == 'warning' %}
                <div class="fixed top-4 right-4 bg-white border-l-4 border-yellow-500 text-gray-800 px-4 py-3 rounded-lg z-50 shadow-lg transition-all duration-300 ease-in-out" id="flashMessage{{ loop.index }}" style="animation: slideInRight 0.3s ease-out;">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2 text-lg text-yellow-500"></i>
                        <span class="font-medium">{{ message }}</span>
                    </div>
                </div>
                {% elif category == 'info' %}
                <div class="fixed top-4 right-4 bg-white border-l-4 border-blue-500 text-gray-800 px-4 py-3 rounded-lg z-50 shadow-lg transition-all duration-300 ease-in-out" id="flashMessage{{ loop.index }}" style="animation: slideInRight 0.3s ease-out;">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle mr-2 text-lg text-blue-500"></i>
                        <span class="font-medium">{{ message }}</span>
                    </div>
                </div>
                {% elif category == 'resolution_summary' %}
                {% set summary_id = 'resolutionSummaryCard' ~ loop.index %}
                {% if summary_id != 'resolutionSummaryCard2' %}
                <div id="{{ summary_id }}" class="fixed top-24 right-4 max-w-md w-full bg-white border border-green-200 text-gray-800 rounded-xl shadow-2xl z-50">
                    <div class="flex items-start justify-between px-4 py-3 border-b border-green-100 bg-green-50 rounded-t-xl">
                        <div>
                            <p class="text-[10px] font-semibold text-green-600 uppercase tracking-widest">Resolution Summary</p>
                            <h3 class="text-sm font-bold text-gray-800 mt-1 leading-5">{{ message.headline }}</h3>
                            <p class="text-[11px] text-gray-500 mt-1">{{ message.incident_label }} • {{ message.resolved_at_display }}</p>
                        </div>
                        <button class="text-green-500 hover:text-green-700 ml-3" onclick="document.getElementById('{{ summary_id }}').style.display='none'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="px-4 py-4 space-y-3 text-sm">
                        {% if message.metrics %}
                        <div class="grid grid-cols-1 gap-2 text-xs text-gray-600">
                            {% for metric in message.metrics %}
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-gray-700">{{ metric.label }}:</span>
                                    <span class="text-right text-gray-600">{{ metric.value }}</span>
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if message.key_points %}
                        <ul class="bg-green-50 border border-green-100 rounded-lg px-3 py-2 text-xs text-green-700 space-y-1">
                            {% for point in message.key_points %}
                                <li>• {{ point }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        <div class="flex items-center justify-between text-[11px] text-gray-500 pt-1">
                            <span>Resolution ID: {{ message.resolved_id }}</span>
                            {% if message.stored %}
                                <span class="inline-flex items-center text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Saved to Supabase</span>
                            {% else %}
                                <span class="inline-flex items-center text-yellow-600 font-medium"><i class="fas fa-exclamation-triangle mr-1"></i>Not saved</span>
                            {% endif %}
                        </div>
                        {% if message.storage_warning %}
                        <div class="text-xs text-red-600 bg-red-50 border border-red-200 rounded px-3 py-2">
                            {{ message.storage_warning }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="fixed top-4 right-4 bg-white border-l-4 border-gray-400 text-gray-800 px-4 py-3 rounded-lg z-50 shadow-lg transition-all duration-300 ease-in-out" id="flashMessage{{ loop.index }}" style="animation: slideInRight 0.3s ease-out;">
                    <div class="flex items-center">
                        <i class="fas fa-bell mr-2 text-lg text-gray-500"></i>
                        <span class="font-medium">{{ message }}</span>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}

    <header class="bg-gray-800 shadow-2xl border-b-4 border-red-600">
        <div class="max-w-8xl mx-auto px-2 sm:px-4 md:px-6 lg:px-10">
            <div class="flex justify-between items-center py-2 md:py-4">
                <div class="flex items-center space-x-2 md:space-x-4 flex-1 min-w-0">
                    <img src="{{ url_for('static', filename='images/ccis.png') }}" alt="CCIS Logo" class="h-8 w-8 md:h-12 md:w-12 lg:h-14 lg:w-14 flex-shrink-0" data-fallback-src="{{ url_for('static', filename='images/ccis.svg') }}">
                    <img src="{{ url_for('static', filename='images/ohso.png') }}" alt="OHSO Logo" class="h-8 w-8 md:h-12 md:w-12 lg:h-14 lg:w-14 flex-shrink-0" data-fallback-src="{{ url_for('static', filename='images/ohso.svg') }}">
                    <img src="{{ url_for('static', filename='images/eas.png') }}" alt="EAS Logo" class="h-8 w-8 md:h-12 md:w-12 lg:h-14 lg:w-14 flex-shrink-0" data-fallback-src="{{ url_for('static', filename='images/eas.svg') }}">
                    <div class="min-w-0 flex-1">
                        <h1 class="text-xs sm:text-sm md:text-lg lg:text-2xl font-bold text-white truncate">UMAK'S EMERGENCY ALERT SYSTEM</h1>
                        <p class="text-xs md:text-sm text-red-300 hidden sm:block">Alert Notifications</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <!-- Desktop Navigation -->
                    <nav class="desktop-nav hidden md:flex items-center space-x-1">
                        <button onclick="showDashboard()" class="nav-btn active px-4 py-2 rounded-lg font-medium transition-colors text-white bg-blue-600">
                            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                        </button>
                        <button onclick="showUserManagement()" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-300 hover:text-white hover:bg-gray-700">
                            <i class="fas fa-users mr-2"></i>Users
                        </button>
                        <button onclick="showIncidentManagement()" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-300 hover:text-white hover:bg-gray-700">
                            <i class="fas fa-clipboard-list mr-2"></i>Incidents
                        </button>
                    </nav>
                    
                    <!-- Mobile Hamburger Menu Button -->
                    <button id="hamburgerBtn" class="hamburger-menu md:hidden text-white p-2 rounded-lg hover:bg-gray-700 transition-colors" onclick="toggleMobileNav()">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
             
                    <div class="flex items-center space-x-2 md:space-x-4 lg:space-x-6">
                        <div class="hidden sm:flex items-center space-x-2">
                            <div class="w-3 h-3 md:w-4 md:h-4 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-xs md:text-sm font-medium text-green-300">System Online</span>
                        </div>
                        
                        <div class="relative">
                            <button id="alertsButton" onclick="highlightAlertNotifications()" 
                                    onmouseenter="showAlertsTooltip(this)" 
                                    onmouseleave="hideAlertsTooltip(this)"
                                    class="bg-red-600 hover:bg-red-700 text-white px-2 py-1.5 md:px-4 md:py-2 rounded-lg font-medium transition-colors text-xs md:text-sm">
                                <i class="fas fa-bell md:mr-2"></i>
                                <span class="hidden sm:inline">Alerts </span>({{ active_alerts_count or 0 }})
                            </button>
                            <div id="alertsTooltip" class="alerts-tooltip">
                                <div class="tooltip-header">
                                    <i class="fas fa-info-circle mr-1"></i>Alert Details
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">
                                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                                        <span>Active Alerts:</span>
                                    </div>
                                    <span class="tooltip-value">
                                        <span id="tooltipActiveCount" class="tooltip-badge active">0</span>
                                    </span>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">
                                        <i class="fas fa-clock text-orange-400"></i>
                                        <span>Pending Alerts:</span>
                                    </div>
                                    <span class="tooltip-value">
                                        <span id="tooltipPendingCount" class="tooltip-badge pending">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <div class="flex items-center space-x-1 md:space-x-2 cursor-pointer" id="profileButton">
                                {% if session.get('admin_profile_exists') and session.admin_profile %}
                                    <img src="{{ url_for('static', filename='images/' + session.admin_profile) }}" 
                                         alt="{{ session.admin_name }}" 
                                         class="w-8 h-8 md:w-10 md:h-10 rounded-full flex-shrink-0 object-cover profile-img"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-xs md:text-sm flex-shrink-0 profile-initials" style="display: none;">
                                        {{ (session.admin_name or 'Admin')|get_initials }}
                                    </div>
                                {% else %}
                                    <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-xs md:text-sm flex-shrink-0">
                                        {{ (session.admin_name or 'Admin')|get_initials }}
                                    </div>
                                {% endif %}
                                <div class="text-xs md:text-sm text-left hidden sm:block">
                                    <p class="font-medium text-white truncate max-w-[100px] md:max-w-none flex items-center gap-1.5">
                                        {{ session.admin_name or 'Admin' }}
                                        {% if session.role == 'Super Admin' or session.role == 'System Administrator' %}
                                        <span class="relative inline-flex items-center group">
                                            <i class="fas fa-crown text-yellow-400 text-sm" 
                                               style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); text-shadow: 0 0 4px rgba(255, 215, 0, 0.5);"></i>
                                            <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2.5 py-1.5 text-xs font-medium text-white bg-gray-900 rounded-md shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50" 
                                                  style="min-width: max-content;">
                                                System Administrator (Super Admin)
                                            </span>
                                        </span>
                                        {% endif %}
                                    </p>
                                    <p class="text-gray-300 text-xs hidden md:block">{{ session.role or 'Administrator' }}</p>
                                </div>
                                <i class="fas fa-chevron-down text-gray-300 text-xs hidden sm:block"></i>
                            </div>
                            
                            <div id="profileDropdown" class="profile-dropdown">
                                <a href="{{ url_for('profile') }}">
                                    <i class="fas fa-user-circle mr-2"></i>My Profile
                                </a>
                                <div class="divider"></div>
                                <a href="{{ url_for('logout') }}">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="autoRefreshIndicator" class="auto-refresh-indicator">
        <i class="fas fa-sync-alt mr-2"></i>Updating dashboard...
    </div>

    <!-- Mobile Navigation Menu -->
    <div id="mobileNav" class="mobile-nav">
        <div class="mobile-nav-content">
            <div class="mobile-nav-header">
                <h2 class="text-2xl font-bold text-white">Menu</h2>
                <button onclick="toggleMobileNav()" class="text-white p-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <nav class="space-y-2">
                <a href="#" onclick="showDashboard(); toggleMobileNav(); return false;" class="mobile-nav-item active flex items-center">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" onclick="showUserManagement(); toggleMobileNav(); return false;" class="mobile-nav-item flex items-center">
                    <i class="fas fa-users mr-3"></i>
                    <span>Users</span>
                </a>
                <a href="#" onclick="showIncidentManagement(); toggleMobileNav(); return false;" class="mobile-nav-item flex items-center">
                    <i class="fas fa-clipboard-list mr-3"></i>
                    <span>Incidents</span>
                </a>
            </nav>
        </div>
    </div>
        
    <!-- Two-Column Dashboard Container -->
    <div class="dashboard-container">
        <!-- LEFT COLUMN - SCROLLABLE -->
        <div class="left-column">
            <!-- Date Filter Buttons -->
            <div class="bg-white p-4 border border-gray-200 rounded-xl shadow-lg mb-6">
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-3">
                    <button onclick="setDateFilter('today')" id="filter-today" class="date-filter-btn active px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700">
                        Today
                    </button>
                    <button onclick="setDateFilter('last_7_days')" id="filter-last_7_days" class="date-filter-btn px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        Last 7 Days
                    </button>
                    <button onclick="setDateFilter('last_30_days')" id="filter-last_30_days" class="date-filter-btn px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        Last 30 Days
                    </button>
                    <button onclick="setDateFilter('last_90_days')" id="filter-last_90_days" class="date-filter-btn px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        Last 90 Days
                    </button>
                    <button onclick="showCustomDateRange()" id="filter-custom" class="date-filter-btn px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        Custom
                    </button>
                    <input type="date" id="custom-start-date" class="hidden border border-gray-300 rounded px-3 py-2 text-sm">
                    <input type="date" id="custom-end-date" class="hidden border border-gray-300 rounded px-3 py-2 text-sm">
                    <button onclick="applyCustomDateRange()" id="apply-custom-date" class="hidden px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-green-600 text-white hover:bg-green-700">
                        Apply
                    </button>
                </div>
            </div>
            
            <!-- TOP SUMMARY -->
            <div class="bg-white p-4 border border-gray-200 rounded-xl shadow-lg mb-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">TOP SUMMARY</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white text-sm font-medium">Total Alerts</p>
                                <p class="text-3xl font-bold mt-1 text-white" id="total-alerts-count">0</p>
                            </div>
                            <i class="fas fa-bell text-4xl text-white"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Resolved Alerts</p>
                                <p class="text-3xl font-bold mt-1" id="resolved-count">0</p>
                            </div>
                            <i class="fas fa-check-circle text-4xl text-green-200"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Avg. Response Time</p>
                                <p class="text-3xl font-bold mt-1" id="avg-response-time">0 min</p>
                            </div>
                            <i class="fas fa-clock text-4xl text-purple-200"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UNIFIED CHARTS DASHBOARD -->
            <div class="bg-white p-4 border border-gray-200 rounded-xl shadow-lg mb-6">
                <!-- Analytics Title -->
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 text-center">Analytics</h2>
                
                <!-- Unified Chart Toggle Buttons -->
                <div class="flex flex-wrap justify-center gap-2 mb-6">
                    <button class="chart-toggle-btn" data-chart="alertCategory" onclick="toggleChart('alertCategory')">
                        <i class="fas fa-chart-pie mr-2 text-blue-600"></i>
                        Alert Category (Pie)
                    </button>
                    <button class="chart-toggle-btn" data-chart="alertsByTime" onclick="toggleChart('alertsByTime')">
                        <i class="fas fa-chart-bar mr-2 text-orange-600"></i>
                        Alerts by Time of Day (Bar)
                    </button>
                    <button class="chart-toggle-btn" data-chart="falseAlerts" onclick="toggleChart('falseAlerts')">
                        <i class="fas fa-chart-pie mr-2 text-red-600"></i>
                        False Alerts (Donut)
                    </button>
                    <button class="chart-toggle-btn" data-chart="studentRegistered" onclick="toggleChart('studentRegistered')">
                        <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
                        Student Registered (Pie)
                    </button>
                    <button class="chart-toggle-btn" data-chart="alertsByCollege" onclick="toggleChart('alertsByCollege')">
                        <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                        Alerts by College & Year Level
                    </button>
                </div>

                <!-- Location Distribution Summary -->
                <div class="bg-gradient-to-br from-slate-50 to-white border border-gray-200 rounded-xl shadow-md mb-6 p-4 md:p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-location-dot text-red-500 text-lg"></i>
                        <h3 class="text-base md:text-lg font-semibold text-gray-800">Location Distribution</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="p-4 rounded-lg border border-green-100 bg-green-50 flex items-center justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wide text-green-600 font-semibold">UMAK (On-Campus)</p>
                                <p class="text-2xl font-bold text-green-700" id="location-on-campus-count">0</p>
                            </div>
                            <i class="fas fa-building text-green-400 text-2xl"></i>
                        </div>
                        <div class="p-4 rounded-lg border border-blue-100 bg-blue-50 flex items-center justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wide text-blue-600 font-semibold">External</p>
                                <p class="text-2xl font-bold text-blue-700" id="location-external-count">0</p>
                            </div>
                            <i class="fas fa-globe-asia text-blue-400 text-2xl"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Chart Display Area -->
                <div class="chart-display-area">
                    <div class="chart-container bg-white p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg hidden" data-chart="alertCategory">
                        <h3 class="text-sm md:text-base font-semibold text-gray-700 mb-3 text-center">
                            <i class="fas fa-chart-pie mr-2 text-blue-600"></i>
                            Alert Category (Pie)
                        </h3>
                        <p class="text-xs text-gray-500 mb-2 text-center">source: icd_category</p>
                        <div class="h-48 md:h-64">
                            <canvas id="alertTypesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg hidden" data-chart="alertsByTime">
                        <h3 class="text-sm md:text-base font-semibold text-gray-700 mb-3 text-center">
                            <i class="fas fa-chart-bar mr-2 text-orange-600"></i>
                            Alerts by Time of Day (Bar)
                        </h3>
                        <p class="text-xs text-gray-500 mb-2 text-center">source: icd_timestamp</p>
                        <div class="h-48 md:h-64">
                            <canvas id="alertsByTimeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg hidden" data-chart="falseAlerts">
                        <h3 class="text-sm md:text-base font-semibold text-gray-700 mb-3 text-center">
                            <i class="fas fa-chart-pie mr-2 text-red-600"></i>
                            False Alerts (Donut)
                        </h3>
                        <p class="text-xs text-gray-500 mb-2 text-center">source: alert_incidents</p>
                        <div class="h-48 md:h-64">
                            <canvas id="falseAlertsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg hidden" data-chart="studentRegistered">
                        <h3 class="text-sm md:text-base font-semibold text-gray-700 mb-3 text-center">
                            <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
                            Student Registered (Pie)
                        </h3>
                        <p class="text-xs text-gray-500 mb-2 text-center">source: student_college/yearlvl</p>
                        <div class="h-48 md:h-64">
                            <canvas id="studentRegisteredChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container bg-white p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg hidden" data-chart="alertsByCollege">
                        <h3 class="text-sm md:text-base font-semibold text-gray-700 mb-3 text-center">
                            <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                            Alerts by College & Year Level
                        </h3>
                        <p class="text-xs text-gray-500 mb-2 text-center">source: alert_incidents + student info</p>
                        <div class="space-y-4">
                            <div class="h-48 md:h-64">
                                <canvas id="alertsByCollegeChart"></canvas>
                            </div>
                            <div class="h-48 md:h-64">
                                <canvas id="alertsByYearLevelChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Map -->
            <div id="liveMapSection" class="bg-content p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg mb-6 md:mb-8">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2">
                    <h2 class="text-lg md:text-xl font-bold text-contrast">
                        <i class="fas fa-map-marked-alt mr-2 text-red-500"></i>
                        Live Map
                    </h2>
                    <div class="flex space-x-2 w-full sm:w-auto">
                        <button onclick="refreshMap()" class="flex-1 sm:flex-none bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 md:px-3 md:py-1 rounded text-xs md:text-sm transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                        <button onclick="toggleFullscreen()" class="flex-1 sm:flex-none bg-gray-600 hover:bg-gray-500 text-white px-3 py-1.5 md:px-3 md:py-1 rounded text-xs md:text-sm transition-colors">
                            <i class="fas fa-expand mr-1"></i>Fullscreen
                        </button>
                    </div>
                </div>
                
                <div class="map-container rounded-lg h-[400px] md:h-[500px] lg:h-[600px] relative overflow-hidden" id="map-container">
                    <div id="map" class="w-full h-full"></div>
                    
                    <!-- Map Filter Buttons -->
                    <div class="map-filter-buttons">
                        <button id="recenterBtn" class="filter-btn" onclick="recenterMap()" title="Recenter to UMAK Campus">
                            <i class="fas fa-crosshairs"></i> Center
                        </button>
                        <button id="allFilter" class="filter-btn active" onclick="filterMarkers('all')">
                            <i class="fas fa-eye"></i> All
                        </button>
                        <button id="activeFilter" class="filter-btn" onclick="filterMarkers('Active')">
                            <i class="fas fa-exclamation-triangle"></i> Active
                        </button>
                        <button id="pendingFilter" class="filter-btn" onclick="filterMarkers('Pending')">
                            <i class="fas fa-clock"></i> Pending
                        </button>
                        <button id="resolvedFilter" class="filter-btn" onclick="filterMarkers('Resolved')">
                            <i class="fas fa-check-circle"></i> Resolved
                        </button>
                        <button id="cancelledFilter" class="filter-btn" onclick="filterMarkers('Cancelled')">
                            <i class="fas fa-times-circle"></i> Cancelled
                        </button>
                    </div>            
                </div>
            </div>

            <!-- Admin Users Table and Incident History Table (side by side) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-8">
            <div class="bg-content p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg">
                <h2 class="text-lg md:text-xl font-bold text-contrast mb-4 md:mb-6">
                    <i class="fas fa-users-cog mr-2 text-blue-600"></i>
                    Admin Users
                </h2>
                
                <div class="admin-users-container h-[500px] md:h-[600px] lg:h-[700px]">
                    <div class="space-y-4 p-1">
                        {% for admin in admin_users or [] %}
                            {% set status_color = 'green' if admin.admin_status == 'Active' else ('yellow' if admin.admin_status == 'Away' else 'gray') %}
                            {% set status_text = admin.admin_status or 'Unknown' %}
                            
                            {% if admin.admin_last_login %}
                                {% set last_login_time = admin.admin_last_login %}
                                {% set last_login = last_login_time|format_datetime %}
                            {% else %}
                                {% set last_login = 'Never' %}
                            {% endif %}
                            
                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200 mb-4">
                                <div class="flex items-center space-x-3">
                                    {% if admin.admin_profile and admin.get('profile_image_exists', False) %}
                                        <img src="{{ url_for('static', filename='images/' + admin.admin_profile) }}" 
                                             alt="{{ admin.admin_fullname }}" 
                                             class="w-10 h-10 rounded-full object-cover"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-sm" style="display: none;">
                                            {{ (admin.admin_fullname or admin.admin_user or 'A')|get_initials }}
                                        </div>
                                    {% else %}
                                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                            {{ (admin.admin_fullname or admin.admin_user or 'A')|get_initials }}
                                        </div>
                                    {% endif %}
                                    
                                    <div>
                                        <h3 class="font-semibold text-gray-900">{{ admin.admin_fullname or admin.admin_user }}</h3>
                                        <p class="text-sm text-gray-600">{{ admin.admin_role or 'Administrator' }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="bg-{{ status_color }}-600 text-white px-3 py-1 rounded-full text-xs font-medium">{{ status_text }}</span>
                                    <p class="text-xs text-gray-500 mt-1">Last: {{ last_login }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="bg-content p-4 md:p-6 border border-gray-200 rounded-xl shadow-lg">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h2 class="text-lg md:text-xl font-bold text-contrast flex items-center gap-2">
                        <i class="fas fa-history text-blue-600"></i>
                        Incident History
                    </h2>
                    <button type="button"
                            onclick="printIncidentHistory()"
                            class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white text-xs md:text-sm font-medium px-3 py-2 rounded-lg shadow-sm transition">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                </div>
                
                <div class="scrollable-activity h-[500px] md:h-[600px] lg:h-[700px]">
                    {% if not recent_activities %}
                        <div class="activity-item text-center text-gray-500">No incident history yet</div>
                    {% else %}
                        {% for activity in recent_activities %}
                            {% set display_status = activity.new_status or activity.icd_status or 'Active' %}
                            {% set status_lower = display_status|lower %}
                            {% if status_lower == 'resolved' %}
                                {% set status_color = 'green' %}
                                {% set status_icon = 'fas fa-check-circle' %}
                                {% set current_status = 'RESOLVED' %}
                            {% elif status_lower == 'cancelled' %}
                                {% set status_color = 'gray' %}
                                {% set status_icon = 'fas fa-times-circle' %}
                                {% set current_status = 'CANCELLED' %}
                            {% elif status_lower == 'pending' %}
                                {% set status_color = 'orange' %}
                                {% set status_icon = 'fas fa-clock' %}
                                {% set current_status = 'PENDING' %}
                            {% else %}
                                {% set status_color = 'red' %}
                                {% set status_icon = 'fas fa-exclamation-triangle' %}
                                {% set current_status = display_status|upper %}
                            {% endif %}
                            {% set event_time = activity.icd_timestamp|format_datetime %}
                            {% set event_label = activity.event_label or ('Status updated to ' ~ current_status) %}

                            <div class="activity-item"
                                 data-incident="ICD_{{ activity.icd_id|string|replace('ICD', '') }}"
                                 data-status="{{ current_status }}"
                                 data-event-label="{{ event_label|e }}"
                                 data-event-type="{{ (activity.event_type or 'Status Update')|e }}"
                                 data-occurred="{{ event_time|e }}"
                                 data-occurred-iso="{{ (
                                    activity.icd_timestamp.isoformat()
                                    if activity.icd_timestamp is defined
                                        and activity.icd_timestamp
                                        and activity.icd_timestamp is not string
                                    else (activity.icd_timestamp if activity.icd_timestamp else '')
                                 )|e }}"
                                 data-previous-status="{{ (activity.old_status or '')|e }}"
                                 data-actor="{{ (activity.event_actor or '')|e }}"
                                 data-actor-role="{{ (activity.event_actor_role or '')|e }}"
                                 data-category="{{ (activity.icd_category or 'N/A')|e }}"
                                 data-student="{{ (activity.student_name or 'N/A')|e }}"
                                 data-reason="{{ (activity.change_reason or '')|e }}"
                                 data-description="{{ (activity.icd_description|default('', true))|e }}">
                                <div class="flex items-start space-x-3">
                                    <div class="w-3 h-3 bg-{{ status_color }}-500 rounded-full mt-1 flex-shrink-0"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-gray-900 mb-1">
                                            <i class="{{ status_icon }} text-{{ status_color }}-500 mr-1"></i>
                                            INCIDENT ID: ICD_{{ activity.icd_id|string|replace('ICD', '') }} - {{ event_label }}
                                        </div>
                                        <div class="text-xs text-gray-600 space-y-1">
                                            <div class="flex justify-between">
                                                <span class="font-medium">Status:</span>
                                                <span class="bg-{{ status_color }}-100 text-{{ status_color }}-800 px-2 py-1 rounded text-xs">{{ current_status }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium">Event Type:</span>
                                                <span>{{ activity.event_type or 'Status Update' }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium">Occurred:</span>
                                                <span>{{ event_time }}</span>
                                            </div>
                                            {% if activity.old_status %}
                                                <div class="flex justify-between">
                                                    <span class="font-medium">Previous Status:</span>
                                                    <span>{{ activity.old_status }}</span>
                                                </div>
                                            {% endif %}
                                            {% if activity.event_actor %}
                                                <div class="flex justify-between">
                                                    <span class="font-medium">{{ (activity.event_actor_role or 'Updated By') }}:</span>
                                                    <span>{{ activity.event_actor }}</span>
                                                </div>
                                            {% endif %}
                                            <div class="flex justify-between">
                                                <span class="font-medium">Category:</span>
                                                <span>{{ activity.icd_category or 'N/A' }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="font-medium">Student:</span>
                                                <span>{{ activity.student_name or 'N/A' }}</span>
                                            </div>
                                            {% if activity.change_reason %}
                                                <div class="flex justify-between">
                                                    <span class="font-medium">Reason:</span>
                                                    <span class="text-right">{{ activity.change_reason }}</span>
                                                </div>
                                            {% endif %}
                                            {% if activity.icd_description %}
                                                <div class="mt-2">
                                                    <span class="font-medium text-gray-600">Description:</span>
                                                    <p class="text-xs text-gray-500 mt-1">{{ activity.icd_description[:120] }}{% if activity.icd_description|length > 120 %}...{% endif %}</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        </div>

        <!-- RIGHT COLUMN - FIXED -->
        <div class="right-column">
            <div id="alertNotificationsSection" class="bg-content p-4 md:p-6 border border-gray-200 h-full flex flex-col" style="height: 100%; max-height: 100%; overflow: hidden;">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 md:mb-6 gap-2">
                    <h2 class="text-lg md:text-xl font-bold text-contrast">
                        <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                        Alert Notification
                    </h2>
                    <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium" data-active-alerts-count="badge">{{ active_alerts_count or 0 }} Active/Pending</span>
                </div>
                
                <!-- Category Filter Buttons -->
                <div class="flex flex-wrap gap-2 mb-4" id="category-filter-buttons">
                    <button onclick="filterAlertsByCategory('all', this)" data-category="all" class="category-filter-btn active text-xs md:text-sm">All</button>
                    <button onclick="filterAlertsByCategory('Urgent', this)" data-category="Urgent" class="category-filter-btn urgent text-xs md:text-sm">Urgent</button>
                    <button onclick="filterAlertsByCategory('Medical', this)" data-category="Medical" class="category-filter-btn medical text-xs md:text-sm">Medical</button>
                    <button onclick="filterAlertsByCategory('Security', this)" data-category="Security" class="category-filter-btn security text-xs md:text-sm">Security</button>
                    <button onclick="filterAlertsByCategory('University', this)" data-category="University" class="category-filter-btn university text-xs md:text-sm">University</button>
                </div>
                
                <div class="scrollable-alerts flex-1" style="max-height: calc(100vh - 240px); overflow-y: auto;">
                    <div class="space-y-4 p-1" id="alerts-container">
                        {% if not all_alerts %}
                            <p class="text-center text-gray-500 py-4">No active or pending alerts</p>
                        {% else %}
                            {% for alert in all_alerts %}
                                {% set category_class = alert.icd_category or 'Unknown' %}
                                {% set category_icon = 'fas fa-exclamation-triangle' if alert.icd_category == 'Urgent' else ('fas fa-heartbeat' if alert.icd_category == 'Medical' else ('fas fa-shield-alt' if alert.icd_category == 'Security' else ('fas fa-university' if alert.icd_category == 'University' else 'fas fa-bell'))) %}
                                {% set category_color = 'text-red-900' if alert.icd_category == 'Urgent' else ('text-red-600' if alert.icd_category == 'Medical' else ('text-blue-900' if alert.icd_category == 'Security' else ('text-yellow-600' if alert.icd_category == 'University' else 'text-gray-600'))) %}
                                {% set category_border_color = 'border-red-900' if alert.icd_category == 'Urgent' else ('border-red-600' if alert.icd_category == 'Medical' else ('border-blue-900' if alert.icd_category == 'Security' else ('border-yellow-500' if alert.icd_category == 'University' else 'border-gray-500'))) %}
                                {% set status_badge_color = 'bg-red-600' if alert.icd_status == 'Active' else ('bg-orange-600' if alert.icd_status == 'Pending' else 'bg-green-600') %}
                                
                                <div class="emergency-card {{ category_class }} p-4 rounded-lg cursor-pointer hover:bg-gray-50 border-l-4 {{ category_border_color }}" 
                                     data-category="{{ alert.icd_category or 'Unknown' }}"
                                     data-alert-id="{{ alert.icd_id }}"
                                     data-user-id="{{ alert.user_id or '' }}">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <i class="{{ category_icon }} {{ category_color }}"></i>
                                            <span class="font-semibold text-sm text-gray-700">{{ alert.icd_category or 'Unknown' }}</span>
                                        </div>
                                        <span class="text-xs text-gray-500">{{ alert.icd_timestamp|format_datetime }}</span>
                                    </div>
                                    <div class="space-y-1">
                                        <h3 class="font-semibold text-gray-900">ICD_{{ alert.icd_id|string|replace('ICD', '') }}</h3>
                                        <p class="text-sm text-gray-600">{{ alert.icd_status }}</p>
                                        
                                        <!-- Enhanced Incident Information -->
                                        {% if alert.icd_description %}
                                            <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{ alert.icd_description[:100] }}{% if alert.icd_description|length > 100 %}...{% endif %}</p>
                                        {% endif %}
                                        
                                        <!-- Student Information -->
                                        {% if alert.student_name %}
                                            <p class="text-xs text-gray-600 mt-1">
                                                <i class="fas fa-user mr-1"></i>{{ alert.student_name }}
                                            </p>
                                        {% endif %}
                                        
                                        <!-- Location Information -->
                                        {% if alert.icd_lat and alert.icd_lng %}
                                            {% set distance_km = ((alert.icd_lat - 14.5633428) ** 2 + (alert.icd_lng - 121.0565387) ** 2) ** 0.5 * 111 %}
                                            <p class="text-xs text-gray-500">
                                                <i class="fas fa-map-marker-alt mr-1"></i>{{ "%.0f"|format(distance_km * 1000) }}m from UMAK
                                            </p>
                                        {% endif %}
                                        
                                        <!-- Status and Timestamps -->
                                        <div class="flex items-center justify-between text-xs mt-2">
                                            <span class="{{ status_badge_color }} text-white px-2 py-1 rounded">{{ alert.icd_status }}</span>
                                            
                                            <!-- Status-specific timestamps -->
                                            {% if alert.resolved_timestamp %}
                                                <span class="text-green-600 text-xs">Resolved: {{ alert.resolved_timestamp|format_datetime }}</span>
                                            {% elif alert.pending_timestamp %}
                                                <span class="text-orange-600 text-xs">Pending: {{ alert.pending_timestamp|format_datetime }}</span>
                                            {% elif alert.cancelled_timestamp %}
                                                <span class="text-gray-600 text-xs">Cancelled: {{ alert.cancelled_timestamp|format_datetime }}</span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Responder Information -->
                                        {% if alert.assigned_responder_id %}
                                            <p class="text-xs text-blue-600 mt-1">
                                                <i class="fas fa-ambulance mr-1"></i>Team Assigned
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Details Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content max-w-screen-3xl w-full">
            <div class="modal-header">
                <h2 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900">Alert Details</h2>
                <button onclick="closeAlertModal()" class="text-gray-400 hover:text-gray-600 flex-shrink-0">
                    <i class="fas fa-times text-lg sm:text-xl"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 items-start">
                    <div class="h-full order-2 lg:order-1">
                        <div class="h-full max-h-[60vh] lg:max-h-[70vh] overflow-y-auto px-2 sm:px-4 lg:px-6" style="direction: rtl;">
                            <div id="alertDetails" class="min-h-[20rem] lg:min-h-[28rem] space-y-3 lg:space-y-4" style="direction: ltr;"></div>
                        </div>
                    </div>
                    <div class="h-full lg:self-start order-1 lg:order-2">
                        <div class="relative w-full h-full min-h-[20rem] sm:min-h-[24rem] lg:min-h-[32rem] rounded-lg overflow-hidden border border-gray-200 lg:sticky lg:top-0">
                            <button id="modalMapRecenter" type="button" class="absolute top-2 right-2 sm:top-4 sm:right-4 z-[1000] bg-white/90 hover:bg-white text-gray-700 border border-gray-200 px-2 py-1 sm:px-3 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium shadow-sm transition">
                                Re-center
                            </button>
                            <div id="modalMap" class="w-full h-full"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <form id="pendingForm" method="POST" action="{{ url_for('mark_pending') }}" class="hidden">
                    <input type="hidden" id="pendingIncidentIdInput" name="incident_id" value="">
                </form>
                
                <form id="cancelledForm" method="POST" action="{{ url_for('mark_cancelled') }}" class="hidden">
                    <input type="hidden" id="cancelledIncidentIdInput" name="incident_id" value="">
                </form>
                
                <button id="chatBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                    <i class="fas fa-comments mr-2"></i>
                    Chat Student
                </button>
                
                <button id="pendingBtn" onclick="markAsPending()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center hidden">
                    <i class="fas fa-clock mr-2"></i>
                    <span class="button-label">Pending</span>
                </button>
                
                <button id="cancelledBtn" onclick="markAsCancelled()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center hidden">
                    <i class="fas fa-times-circle mr-2"></i>
                    Mark as Cancelled
                </button>
                
                <button id="resolveBtn" onclick="markAsResolved()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Mark Resolved
                </button>
            </div>
        </div>
    </div>

    <!-- Pending Confirmation Modal -->
    <div id="pendingConfirmModal" class="modal">
        <div class="modal-content max-w-md w-full">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Confirm Set to Pending</h2>
                <button onclick="closePendingConfirmModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="mb-4">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-exclamation-triangle text-orange-500 text-2xl mr-3"></i>
                        <p class="text-gray-700 font-medium">Are you sure you want to set this incident to pending status?</p>
                    </div>
                    
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                        <p class="text-sm font-semibold text-orange-900 mb-2">This action will:</p>
                        <ul class="text-sm text-orange-800 space-y-1 list-disc list-inside">
                            <li>Change the status to <strong>"Pending"</strong></li>
                            <li>Mark it as <strong>"Acknowledged"</strong></li>
                            <li>Set it to <strong>"In Progress"</strong></li>
                        </ul>
                    </div>
                    
                    <p class="text-sm text-gray-600">This will update the incident status in the system and notify relevant parties.</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closePendingConfirmModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button type="button" onclick="confirmPendingAction()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    Confirm Set to Pending
                </button>
            </div>
        </div>
    </div>

    <!-- Resolved Confirmation Modal -->
    <div id="resolvedConfirmModal" class="modal">
        <div class="modal-content max-w-md w-full">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Confirm Mark as Resolved</h2>
                <button onclick="closeResolvedConfirmModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="mb-4">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                        <p class="text-gray-700 font-medium">Are you sure you want to mark this incident as resolved?</p>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <p class="text-sm font-semibold text-green-900 mb-2">This action will:</p>
                        <ul class="text-sm text-green-800 space-y-1 list-disc list-inside">
                            <li>Change the status to <strong>"Resolved"</strong></li>
                            <li>Update the <strong>resolved_timestamp</strong> to the current time</li>
                            <li>Mark the incident as <strong>"Completed"</strong></li>
                        </ul>
                    </div>
                    
                    <p class="text-sm text-gray-600">This will update the incident status and timestamp in the system and notify relevant parties.</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closeResolvedConfirmModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button type="button" onclick="confirmResolvedAction()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Confirm Mark as Resolved
                </button>
            </div>
        </div>
    </div>

    <!-- Resolution Summary Modal -->
    <div id="resolutionSummaryModal" class="modal">
        <div class="modal-content max-w-2xl w-full overflow-hidden">
            <div class="modal-header bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="fas fa-clipboard-check text-lg"></i>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.35em] font-semibold text-white/80">Resolution Summary</p>
                        <h2 id="summaryModalHeadline" class="text-lg font-bold">Incident resolved by:</h2>
                    </div>
                </div>
                <button type="button" onclick="closeResolutionSummaryModal()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="resolutionSummaryForm" method="POST" action="{{ url_for('mark_resolved') }}">
                <div class="modal-body space-y-5 bg-slate-50">
                    <input type="hidden" id="incidentIdInput" name="incident_id" value="">

                    <div class="bg-white rounded-xl shadow-inner border border-slate-200 px-4 py-3 flex items-center justify-between">
                        <div>
                            <p class="text-xs uppercase font-semibold text-slate-500 tracking-[0.3em]">Reference</p>
                            <p id="summaryModalTimestamp" class="text-sm font-medium text-slate-800">—</p>
                        </div>
                        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-800 text-xs font-semibold uppercase tracking-wide">
                            <i class="fas fa-shield-check"></i> Final Report
                        </span>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div class="bg-white rounded-lg border border-slate-200 px-4 py-3 shadow-sm">
                            <p class="text-[11px] uppercase text-slate-500 font-semibold tracking-[0.3em]">Reported</p>
                            <p id="summaryModalReportedAt" class="text-sm font-semibold text-slate-900 mt-1">—</p>
                        </div>
                        <div class="bg-white rounded-lg border border-slate-200 px-4 py-3 shadow-sm">
                            <p class="text-[11px] uppercase text-slate-500 font-semibold tracking-[0.3em]">Resolved</p>
                            <p id="summaryModalResolvedAt" class="text-sm font-semibold text-slate-900 mt-1">—</p>
                        </div>
                        <div class="bg-white rounded-lg border border-slate-200 px-4 py-3 shadow-sm">
                            <p class="text-[11px] uppercase text-slate-500 font-semibold tracking-[0.3em]">Response Time</p>
                            <p id="summaryModalResponseTime" class="text-sm font-semibold text-slate-900 mt-1">—</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-white rounded-lg border border-slate-200 px-4 py-3 shadow-sm">
                            <p class="text-[11px] uppercase text-slate-500 font-semibold tracking-[0.3em] mb-2">Key Details</p>
                            <dl class="space-y-2 text-sm text-slate-700">
                                <div class="flex justify-between">
                                    <dt class="font-medium text-slate-500">Handled by</dt>
                                    <dd id="summaryModalHandledBy" class="font-semibold text-slate-900">—</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="font-medium text-slate-500">Student</dt>
                                    <dd id="summaryModalStudent" class="font-semibold text-slate-900">—</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="font-medium text-slate-500">Category</dt>
                                    <dd id="summaryModalCategory" class="font-semibold text-slate-900">—</dd>
                                </div>
                            </dl>
                        </div>
                        <div class="bg-white rounded-lg border border-slate-200 px-4 py-3 shadow-sm">
                            <p class="text-[11px] uppercase text-slate-500 font-semibold tracking-[0.3em] mb-2">Guidance</p>
                            <ul class="text-sm text-slate-600 space-y-2">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-circle text-[6px] text-green-400 mt-1.5"></i>
                                    Provide a concise narrative of how the incident was resolved.
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-circle text-[6px] text-green-400 mt-1.5"></i>
                                    Mention key actions, coordination steps, and outcomes.
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-circle text-[6px] text-green-400 mt-1.5"></i>
                                    Keep the summary factual—this will be stored as the official record.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg border border-slate-200 px-4 py-4 shadow-sm">
                        <label for="resolutionSummaryInput" class="block text-sm font-semibold text-slate-700 mb-2">
                            Final Summary <span class="text-red-500">*</span>
                        </label>
                        <textarea id="resolutionSummaryInput"
                                  name="resolution_summary"
                                  rows="5"
                                  class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                                  placeholder="Example: Coordinated with the campus clinic to stabilize the student, escorted to medical center, incident closed after confirming full recovery."
                                  required
                                  minlength="12"></textarea>
                        <div class="mt-2 flex items-center justify-between text-xs text-slate-500">
                            <span>This narrative will appear in the incident history report.</span>
                            <span id="resolutionSummaryCharCount">0 characters</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-slate-100 border-t border-slate-200">
                    <button type="button" onclick="closeResolutionSummaryModal()" class="bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="resolutionSummarySubmitBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        Submit &amp; Archive
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cancelled Confirmation Modal -->
    <div id="cancelledConfirmModal" class="modal">
        <div class="modal-content max-w-md w-full">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Confirm Mark as Cancelled</h2>
                <button onclick="closeCancelledConfirmModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="mb-4">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-times-circle text-gray-500 text-2xl mr-3"></i>
                        <p class="text-gray-700 font-medium">Are you sure you want to mark this incident as cancelled?</p>
                    </div>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                        <p class="text-sm font-semibold text-gray-900 mb-2">This action will:</p>
                        <ul class="text-sm text-gray-800 space-y-1 list-disc list-inside">
                            <li>Change the status to <strong>"Cancelled"</strong></li>
                            <li>Update the <strong>cancelled_timestamp</strong> to the current time</li>
                            <li>Mark the incident as <strong>"Terminated"</strong></li>
                        </ul>
                    </div>
                    
                    <p class="text-sm text-gray-600">This will update the incident status and timestamp in the system and notify relevant parties.</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="closeCancelledConfirmModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button type="button" onclick="confirmCancelledAction()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                    <i class="fas fa-times-circle mr-2"></i>
                    Confirm Mark as Cancelled
                </button>
            </div>
        </div>
    </div>

    <!-- Dispatch Modal -->
    <div id="dispatchModal" class="modal">
        <div class="modal-content max-w-md w-full">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Dispatch Emergency Team</h2>
                <button onclick="closeDispatchModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="dispatchForm" method="POST" action="{{ url_for('dispatch_team') }}">
                <div class="modal-body">
                    <input type="hidden" id="dispatchIncidentIdInput" name="incident_id" value="">
                    
                    <div class="mb-4">
                        <p class="text-gray-700 mb-4">Select an admin responder to assign to this emergency incident:</p>
                        
                        <label for="responder_id" class="block text-sm font-medium text-gray-700 mb-2">
                            Assign Responder:
                        </label>
                        <select name="responder_id" id="responder_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            <option value="">Select a responder...</option>
                            {% for admin in admin_list or [] %}
                                <option value="{{ admin.admin_id }}">
                                    {{ admin.admin_fullname }} ({{ admin.admin_role }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-yellow-500 mr-2"></i>
                            <p class="text-sm text-yellow-700">
                                This will assign the selected responder and change the incident status to "Pending".
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" onclick="closeDispatchModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                        <i class="fas fa-ambulance mr-2"></i>
                        Proceed Dispatch
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gradient-to-r from-slate-800 to-slate-900 text-white py-12">
        <div class="max-w-6xl mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">

                <div class="text-center">
                    <div class="mb-4 flex justify-center">
                        <a href="/developers" target="_blank">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                            </div>
                        </a>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Contact Us</h3>
                    <p class="text-gray-300 leading-relaxed mb-3">Group - Eclipse</p>
                    <a href="/developers" class="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-full hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>

                <div class="text-center">
                    <div class="mb-4 flex justify-center">
                        <a href="https://www.facebook.com/UMakPH" target="_blank">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                        </a>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">UMAK</h3>
                    <p class="text-gray-300 leading-relaxed mb-2">University of Makati</p>
                    <p class="text-gray-300 text-sm leading-relaxed mb-2">J.P. Rizal Extension, West Rembo, 1644 City of Taguig, Metro Manila, Philippines</p>
                    <p class="text-gray-300 text-sm">
                        Email: <a href="mailto:info@umak.edu.ph" class="text-blue-300 hover:text-blue-200 underline">info@umak.edu.ph</a>
                    </p>
                </div>

                <div class="text-center">
                    <div class="mb-4 flex justify-center">
                        <a href="mailto:ohso@umak.edu.ph" target="_blank">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </a>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">OHSO</h3>
                    <p class="text-gray-300 leading-relaxed mb-2">Occupational Health and Safety Office</p>
                    <div class="space-y-1 text-gray-300 text-sm">
                        <p>
                            Email: <a href="mailto:ohso@umak.edu.ph" class="text-blue-300 hover:text-blue-200 underline">ohso@umak.edu.ph</a>
                        </p>
                        <p>
                            Direct Line: <a href="tel:0288820535" class="text-blue-300 hover:text-blue-200 underline">(02) 8882-0535</a>
                        </p>
                    </div>
                </div>

                <div class="text-center">
                    <div class="mb-4 flex justify-center">
                        <a href="tel:09480763795" target="_blank">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 20h8m-4-4v4"></path>
                                </svg>
                            </div>
                        </a>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">CCIS</h3>
                    <p class="text-gray-300 leading-relaxed mb-2">College of Computing and Information Sciences</p>
                    <div class="space-y-1 text-gray-300 text-sm">
                        <p>
                            E-mail: <a href="mailto:umakccissc@umak.edu.ph" class="text-blue-300 hover:text-blue-200 underline">umakccissc@umak.edu.ph</a>
                        </p>
                        <p>
                            Mobile No.: <a href="tel:09480763795" class="text-blue-300 hover:text-blue-200 underline">09480763795</a>
                        </p>
                    </div>
                </div>		
            </div>
            <div class="mt-12 pt-8 border-t border-gray-700 text-center">
                <p class="text-gray-400">&copy; {{ current_year }} III-DINS, GROUP ECLIPSE. Emergency Alert System. All rights reserved.</p>
            </div>
        </div>
</footer>

    <script type="application/json" id="locations-data">{{ incidents|tojson }}</script>
    <script>
        // Enhanced JavaScript functionality from PHP version
        let map;
        let modalMap;
        let markers = [];
        let modalMarkers = [];
        let modalMapTargetLatLng = null;
        let currentFilter = 'all';
        let currentIncidentId = null;
        let currentIncidentStatus = null;
        let currentIncidentContext = null;
        let umakCircle; // Variable to store the UMAK radius circle
        
        const UMAK_LAT = 14.5633428;
        const UMAK_LNG = 121.0565387;
        let locations = [];
        (function initializeLocations() {
            const locationsElement = document.getElementById('locations-data');
            if (!locationsElement) {
                console.warn('Locations data element is missing.');
                return;
            }
            try {
                const raw = locationsElement.textContent || '[]';
                locations = JSON.parse(raw);
            } catch (error) {
                console.error('Failed to parse locations data:', error);
                locations = [];
            }
        })();

        const REFRESH_INTERVAL_MS = 30000; // 30 seconds
        const DEFAULT_TIME_ZONE = 'Asia/Manila';
        let currentAlertCategory = 'all';
        const LOGGED_IN_ADMIN_NAME = (document.body && document.body.dataset && document.body.dataset.adminName) || 'Administrator';
        const LOGGED_IN_ADMIN_ID = (document.body && document.body.dataset && document.body.dataset.adminId) || '';

        function escapeHtml(value = '') {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatDateTime(value, options = {}) {
            if (!value) {
                return 'N/A';
            }
            try {
                const date = value instanceof Date ? value : new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return typeof value === 'string' ? value : 'N/A';
                }
                const baseOptions = {
                    timeZone: DEFAULT_TIME_ZONE,
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                };
                return date.toLocaleString('en-PH', { ...baseOptions, ...options });
            } catch (error) {
                return typeof value === 'string' ? value : 'N/A';
            }
        }

        function toIsoString(value) {
            if (!value) {
                return '';
            }
            try {
                const date = value instanceof Date ? value : new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return '';
                }
                return date.toISOString();
            } catch (error) {
                return '';
            }
        }

        function formatResponseDuration(startTime, endTime) {
            if (!startTime || !endTime) {
                return 'N/A';
            }
            try {
                const start = new Date(startTime);
                const end = new Date(endTime);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime()) || end < start) {
                    return 'N/A';
                }
                const diffMinutes = (end - start) / 60000;
                if (diffMinutes < 1) {
                    const seconds = Math.max(1, Math.round(diffMinutes * 60));
                    return `${seconds} sec${seconds !== 1 ? 's' : ''}`;
                }
                if (diffMinutes < 60) {
                    return `${Math.round(diffMinutes)} min${Math.round(diffMinutes) !== 1 ? 's' : ''}`;
                }
                const hours = Math.floor(diffMinutes / 60);
                const minutes = Math.round(diffMinutes % 60);
                let label = `${hours} hr${hours !== 1 ? 's' : ''}`;
                if (minutes > 0) {
                    label += ` ${minutes} min${minutes !== 1 ? 's' : ''}`;
                }
                return label;
            } catch (error) {
                return 'N/A';
            }
        }

        function formatIncidentDatasetId(incidentId) {
            if (incidentId === undefined || incidentId === null) {
                return 'ICD_';
            }
            const str = String(incidentId);
            const cleaned = str.replace(/^(ICD_?|icd_?)/, '');
            return `ICD_${cleaned}`;
        }

        function formatIncidentDisplayId(incidentId) {
            if (incidentId === undefined || incidentId === null) {
                return 'ICD';
            }
            const str = String(incidentId).toUpperCase();
            return str.startsWith('ICD') ? str : `ICD_${str}`;
        }

        function getStatusVisuals(statusValue) {
            const status = (statusValue || 'Active').toString().toLowerCase();
            switch (status) {
                case 'resolved':
                    return {
                        statusColor: 'green',
                        statusIcon: 'fas fa-check-circle',
                        currentStatus: 'RESOLVED',
                        badgeTextClass: 'bg-green-100 text-green-800',
                        badgeClass: 'bg-green-600'
                    };
                case 'cancelled':
                    return {
                        statusColor: 'gray',
                        statusIcon: 'fas fa-times-circle',
                        currentStatus: 'CANCELLED',
                        badgeTextClass: 'bg-gray-100 text-gray-800',
                        badgeClass: 'bg-gray-500'
                    };
                case 'pending':
                    return {
                        statusColor: 'orange',
                        statusIcon: 'fas fa-clock',
                        currentStatus: 'PENDING',
                        badgeTextClass: 'bg-orange-100 text-orange-800',
                        badgeClass: 'bg-orange-600'
                    };
                default:
                    return {
                        statusColor: 'red',
                        statusIcon: 'fas fa-exclamation-triangle',
                        currentStatus: statusValue ? statusValue.toString().toUpperCase() : 'ACTIVE',
                        badgeTextClass: 'bg-red-100 text-red-800',
                        badgeClass: 'bg-red-600'
                    };
            }
        }

        function getCategoryVisuals(categoryValue) {
            const category = (categoryValue || 'Unknown').toString();
            switch (category) {
                case 'Urgent':
                    return {
                        categoryClass: 'Urgent',
                        iconClass: 'fas fa-exclamation-triangle',
                        colorClass: 'text-red-900',
                        borderClass: 'border-red-900'
                    };
                case 'Medical':
                    return {
                        categoryClass: 'Medical',
                        iconClass: 'fas fa-heartbeat',
                        colorClass: 'text-red-600',
                        borderClass: 'border-red-600'
                    };
                case 'Security':
                    return {
                        categoryClass: 'Security',
                        iconClass: 'fas fa-shield-alt',
                        colorClass: 'text-blue-900',
                        borderClass: 'border-blue-900'
                    };
                case 'University':
                    return {
                        categoryClass: 'University',
                        iconClass: 'fas fa-university',
                        colorClass: 'text-yellow-600',
                        borderClass: 'border-yellow-500'
                    };
                default:
                    return {
                        categoryClass: category || 'Unknown',
                        iconClass: 'fas fa-bell',
                        colorClass: 'text-gray-600',
                        borderClass: 'border-gray-500'
                    };
            }
        }

        function truncateText(text, limit = 120) {
            if (!text) {
                return '';
            }
            const str = String(text);
            return str.length > limit ? `${str.slice(0, limit).trim()}…` : str;
        }

        function updateActiveAlertsCount(count) {
            const parsed = Number(count);
            const displayValue = Number.isFinite(parsed) ? parsed : 0;
            document.querySelectorAll('[data-active-alerts-count]').forEach(element => {
                const mode = element.dataset.activeAlertsCount;
                if (mode === 'badge') {
                    element.textContent = `${displayValue} Active/Pending`;
                } else {
                    element.textContent = displayValue;
                }
            });
        }

        function renderAlertCard(alert) {
            if (!alert) {
                return '';
            }

            const categoryVisuals = getCategoryVisuals(alert.icd_category);
            const statusVisuals = getStatusVisuals(alert.icd_status);
            const incidentDisplayId = formatIncidentDisplayId(alert.icd_id);
            const formattedTimestamp = formatDateTime(alert.icd_timestamp);

            const descriptionBlock = alert.icd_description
                ? `<p class="text-xs text-gray-500 mt-1 line-clamp-2">${escapeHtml(truncateText(alert.icd_description, 100))}</p>`
                : '';

            const studentName = alert.student_name || alert.student_fullname || alert.student || '';
            const studentBlock = studentName
                ? `<p class="text-xs text-gray-600 mt-1">
                        <i class="fas fa-user mr-1"></i>${escapeHtml(studentName)}
                   </p>`
                : '';

            let locationBlock = '';
            const lat = parseFloat(alert.icd_lat);
            const lng = parseFloat(alert.icd_lng);
            if (!Number.isNaN(lat) && !Number.isNaN(lng)) {
                const distanceKm = calculateDistance(UMAK_LAT, UMAK_LNG, lat, lng);
                if (Number.isFinite(distanceKm)) {
                    const distanceMeters = Math.round(distanceKm * 1000);
                    locationBlock = `<p class="text-xs text-gray-500">
                        <i class="fas fa-map-marker-alt mr-1"></i>${distanceMeters}m from UMAK
                    </p>`;
                }
            }

            let statusTimestampLine = '';
            if (alert.resolved_timestamp) {
                statusTimestampLine = `<span class="text-green-600 text-xs">Resolved: ${escapeHtml(formatDateTime(alert.resolved_timestamp))}</span>`;
            } else if (alert.pending_timestamp) {
                statusTimestampLine = `<span class="text-orange-600 text-xs">Pending: ${escapeHtml(formatDateTime(alert.pending_timestamp))}</span>`;
            } else if (alert.cancelled_timestamp) {
                statusTimestampLine = `<span class="text-gray-600 text-xs">Cancelled: ${escapeHtml(formatDateTime(alert.cancelled_timestamp))}</span>`;
            }

            const responderBlock = alert.assigned_responder_id
                ? `<p class="text-xs text-blue-600 mt-1">
                        <i class="fas fa-ambulance mr-1"></i>Team Assigned
                   </p>`
                : '';

            const cardCategory = escapeHtml(alert.icd_category || 'Unknown');
            const userIdValue = alert.user_id !== undefined && alert.user_id !== null ? String(alert.user_id) : '';
            const alertStatus = alert.icd_status || 'Unknown';

            return `
                <div class="emergency-card ${escapeHtml(categoryVisuals.categoryClass)} p-4 rounded-lg cursor-pointer hover:bg-gray-50 border-l-4 ${categoryVisuals.borderClass}"
                     data-category="${cardCategory}"
                     data-alert-id="${escapeHtml(alert.icd_id)}"
                     data-user-id="${escapeHtml(userIdValue)}">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i class="${categoryVisuals.iconClass} ${categoryVisuals.colorClass}"></i>
                            <span class="font-semibold text-sm text-gray-700">${escapeHtml(alert.icd_category || 'Unknown')}</span>
                        </div>
                        <span class="text-xs text-gray-500">${escapeHtml(formattedTimestamp)}</span>
                    </div>
                    <div class="space-y-1">
                        <h3 class="font-semibold text-gray-900">${escapeHtml(incidentDisplayId)}</h3>
                        <p class="text-sm text-gray-600">${escapeHtml(alertStatus)}</p>
                        ${descriptionBlock}
                        ${studentBlock}
                        ${locationBlock}
                        <div class="flex items-center justify-between text-xs mt-2">
                            <span class="${statusVisuals.badgeClass} text-white px-2 py-1 rounded">${escapeHtml(alertStatus)}</span>
                            ${statusTimestampLine}
                        </div>
                        ${responderBlock}
                    </div>
                </div>
            `;
        }

        function updateAlertsList(alerts = []) {
            const container = document.getElementById('alerts-container');
            if (!container) {
                return;
            }

            // Preserve scroll position
            const scrollTop = container.scrollTop;
            const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;

            if (!Array.isArray(alerts) || alerts.length === 0) {
                if (container.children.length === 0 || container.textContent.trim() === '') {
                    container.innerHTML = '<p class="text-center text-gray-500 py-4">No active or pending alerts</p>';
                }
                updateActiveAlertsCount(0);
                return;
            }

            // Use DocumentFragment for smoother updates
            const fragment = document.createDocumentFragment();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = alerts.map(renderAlertCard).join('');
            
            while (tempDiv.firstChild) {
                fragment.appendChild(tempDiv.firstChild);
            }

            // Use requestAnimationFrame for smooth updates
            requestAnimationFrame(() => {
                // Clear container and append new content
                container.innerHTML = '';
                container.appendChild(fragment);
                wireAlertCardEvents();

                // Restore scroll position or scroll to bottom if user was at bottom
                requestAnimationFrame(() => {
                    if (wasAtBottom) {
                        container.scrollTop = container.scrollHeight;
                    } else {
                        container.scrollTop = scrollTop;
                    }
                });

                const activePendingCount = alerts.filter(alert => {
                    const status = (alert.icd_status || '').toString().toLowerCase();
                    return status === 'active' || status === 'pending';
                }).length;
                updateActiveAlertsCount(activePendingCount);

                filterAlertsByCategory(currentAlertCategory);
            });
        }

        function renderActivityItem(activity) {
            if (!activity) {
                return '';
            }

            const statusVisuals = getStatusVisuals(activity.new_status || activity.icd_status || 'Active');
            const eventLabel = activity.event_label || `Status updated to ${statusVisuals.currentStatus}`;
            const eventType = activity.event_type || 'Status Update';
            const occurredDisplay = formatDateTime(activity.icd_timestamp);
            const previousStatus = activity.old_status;
            const actorName = activity.event_actor || '';
            const actorRole = activity.event_actor_role || (actorName ? 'Updated By' : '');
            const reason = activity.change_reason || '';
            const description = activity.icd_description || '';
            const categoryValue = activity.icd_category || 'N/A';
            const studentValue = activity.student_name || 'N/A';
            const datasetIncident = formatIncidentDatasetId(activity.icd_id);
            const incidentDisplayId = formatIncidentDisplayId(activity.icd_id);

            const previousStatusRow = previousStatus ? `
                <div class="flex justify-between">
                    <span class="font-medium">Previous Status:</span>
                    <span>${escapeHtml(previousStatus)}</span>
                </div>` : '';

            const actorRow = actorName ? `
                <div class="flex justify-between">
                    <span class="font-medium">${escapeHtml(actorRole)}:</span>
                    <span>${escapeHtml(actorName)}</span>
                </div>` : '';

            const reasonRow = reason ? `
                <div class="flex justify-between">
                    <span class="font-medium">Reason:</span>
                    <span class="text-right">${escapeHtml(reason)}</span>
                </div>` : '';

            const descriptionRow = description ? `
                <div class="mt-2">
                    <span class="font-medium text-gray-600">Description:</span>
                    <p class="text-xs text-gray-500 mt-1">${escapeHtml(truncateText(description, 120))}</p>
                </div>` : '';

            return `
                <div class="activity-item"
                     data-incident="${escapeHtml(datasetIncident)}"
                     data-status="${escapeHtml(statusVisuals.currentStatus)}"
                     data-event-label="${escapeHtml(eventLabel)}"
                     data-event-type="${escapeHtml(eventType)}"
                     data-occurred="${escapeHtml(occurredDisplay)}"
                     data-occurred-iso="${escapeHtml(toIsoString(activity.icd_timestamp))}"
                     data-previous-status="${escapeHtml(previousStatus || '')}"
                     data-actor="${escapeHtml(actorName)}"
                     data-actor-role="${escapeHtml(actorRole)}"
                     data-category="${escapeHtml(categoryValue)}"
                     data-student="${escapeHtml(studentValue)}"
                     data-reason="${escapeHtml(reason)}"
                     data-description="${escapeHtml(description)}">
                    <div class="flex items-start space-x-3">
                        <div class="w-3 h-3 bg-${statusVisuals.statusColor}-500 rounded-full mt-1 flex-shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 mb-1">
                                <i class="${statusVisuals.statusIcon} text-${statusVisuals.statusColor}-500 mr-1"></i>
                                ${escapeHtml(incidentDisplayId)} - ${escapeHtml(eventLabel)}
                            </div>
                            <div class="text-xs text-gray-600 space-y-1">
                                <div class="flex justify-between">
                                    <span class="font-medium">Status:</span>
                                    <span class="bg-${statusVisuals.statusColor}-100 text-${statusVisuals.statusColor}-800 px-2 py-1 rounded text-xs">${escapeHtml(statusVisuals.currentStatus)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">Event Type:</span>
                                    <span>${escapeHtml(eventType)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">Occurred:</span>
                                    <span>${escapeHtml(occurredDisplay)}</span>
                                </div>
                                ${previousStatusRow}
                                ${actorRow}
                                <div class="flex justify-between">
                                    <span class="font-medium">Category:</span>
                                    <span>${escapeHtml(categoryValue)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">Student:</span>
                                    <span>${escapeHtml(studentValue)}</span>
                                </div>
                                ${reasonRow}
                                ${descriptionRow}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateActivityFeed(activities = []) {
            const container = document.querySelector('.scrollable-activity');
            if (!container) {
                return;
            }

            // Preserve scroll position
            const scrollTop = container.scrollTop;
            const wasAtTop = container.scrollTop < 50;

            if (!Array.isArray(activities) || activities.length === 0) {
                if (container.children.length === 0 || container.textContent.trim() === '') {
                    container.innerHTML = '<div class="activity-item text-center text-gray-500">No incident history yet</div>';
                }
                return;
            }

            // Use DocumentFragment for smoother updates
            const fragment = document.createDocumentFragment();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = activities.map(renderActivityItem).join('');
            
            while (tempDiv.firstChild) {
                fragment.appendChild(tempDiv.firstChild);
            }

            // Use requestAnimationFrame for smooth updates
            requestAnimationFrame(() => {
                container.innerHTML = '';
                container.appendChild(fragment);
                
                // Restore scroll position (keep at top if user was at top)
                requestAnimationFrame(() => {
                    if (wasAtTop) {
                        container.scrollTop = 0;
                    } else {
                        container.scrollTop = scrollTop;
                    }
                });
            });
        }

        async function updateLocationsData(newLocations = []) {
            // Only update if locations actually changed
            const newLocationsArray = Array.isArray(newLocations) ? newLocations : [];
            // Create normalized comparison (sort by id for consistent comparison)
            const normalizeLocations = (locs) => locs.map(l => ({ 
                id: l.icd_id, 
                lat: l.icd_lat, 
                lng: l.icd_lng,
                status: l.icd_status
            })).sort((a, b) => (a.id || '').localeCompare(b.id || ''));
            
            const hasChanged = JSON.stringify(normalizeLocations(locations)) !== 
                              JSON.stringify(normalizeLocations(newLocationsArray));
            
            if (!hasChanged && locations.length > 0) {
                return; // No changes, skip update
            }
            
            locations = newLocationsArray;
            
            // Preserve map view state
            const currentCenter = map.getCenter();
            const currentZoom = map.getZoom();
            const currentCenterLat = currentCenter.lat;
            const currentCenterLng = currentCenter.lng;
            
            // Use requestAnimationFrame for smoother updates
            await new Promise(resolve => requestAnimationFrame(resolve));
            await addIncidentMarkers();
            filterMarkers(currentFilter || 'all');
            
            // Restore map view (only if it hasn't changed significantly)
            requestAnimationFrame(() => {
                const newCenter = map.getCenter();
                const latDiff = Math.abs(newCenter.lat - currentCenterLat);
                const lngDiff = Math.abs(newCenter.lng - currentCenterLng);
                if (latDiff < 0.001 && lngDiff < 0.001) {
                    map.setView(currentCenter, currentZoom, { animate: false });
                }
            });
        }

        function wireAlertCardEvents() {
            document.querySelectorAll('.emergency-card[data-alert-id]').forEach(card => {
                card.addEventListener('click', () => {
                    const alertId = card.getAttribute('data-alert-id');
                    const userId = card.getAttribute('data-user-id') || '';
                    showAlertDetails(alertId, userId);
                });
            });
        }

        // Cache for detecting data changes
        let lastAlertsHash = null;
        let lastActivitiesHash = null;
        let lastIncidentsHash = null;
        let isRefreshing = false;
        let lastAlertsData = null;
        let lastActivitiesData = null;
        let lastIncidentsData = null;

        // Helper function to create a comprehensive hash of data
        function createDataHash(data) {
            if (!data || !Array.isArray(data)) return null;
            return JSON.stringify(data.map(item => ({
                id: item.icd_id || item.id,
                status: item.icd_status || item.status,
                timestamp: item.icd_timestamp || item.timestamp,
                category: item.icd_category || item.category,
                resolved_timestamp: item.resolved_timestamp,
                pending_timestamp: item.pending_timestamp,
                cancelled_timestamp: item.cancelled_timestamp
            })).sort((a, b) => (a.id || '').localeCompare(b.id || '')));
        }

        async function refreshDashboardData() {
            // Prevent concurrent refreshes
            if (isRefreshing) {
                return;
            }
            isRefreshing = true;

            const indicator = document.getElementById('autoRefreshIndicator');
            if (indicator) {
                indicator.classList.add('show');
            }

            try {
                // Build API URLs with date filter
                let incidentsUrl = `/api/incidents?status=all&date_range=${currentDateRange}`;
                if (currentDateRange === 'custom') {
                    const startDate = document.getElementById('custom-start-date')?.value || '';
                    const endDate = document.getElementById('custom-end-date')?.value || '';
                    if (startDate && endDate) {
                        incidentsUrl += `&start_date=${startDate}&end_date=${endDate}`;
                    }
                }
                const alertsUrl = buildApiUrl('/api/alerts');
                const activityUrl = buildApiUrl('/api/activity-feed');
                
                const [incidentsResponse, alertsResponse, activityResponse] = await Promise.all([
                    fetch(incidentsUrl),
                    fetch(alertsUrl),
                    fetch(activityUrl)
                ]);

                if (incidentsResponse.status === 401 || alertsResponse.status === 401 || activityResponse.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                const [incidentsData, alertsData, activitiesData] = await Promise.all([
                    incidentsResponse.json(),
                    alertsResponse.json(),
                    activityResponse.json()
                ]);

                // Only update if data has changed
                if (incidentsData && incidentsData.success) {
                    const newHash = createDataHash(incidentsData.incidents);
                    if (newHash !== lastIncidentsHash) {
                        lastIncidentsHash = newHash;
                        lastIncidentsData = incidentsData.incidents || [];
                        await updateLocationsData(lastIncidentsData);
                    }
                }

                if (alertsData && alertsData.success) {
                    const newHash = createDataHash(alertsData.alerts);
                    if (newHash !== lastAlertsHash) {
                        lastAlertsHash = newHash;
                        lastAlertsData = alertsData.alerts || [];
                        updateAlertsList(lastAlertsData);
                    }
                } else if (alertsData && alertsData.count !== undefined) {
                    updateActiveAlertsCount(alertsData.count);
                }

                if (activitiesData && activitiesData.success) {
                    const newHash = createDataHash(activitiesData.activities);
                    if (newHash !== lastActivitiesHash) {
                        lastActivitiesHash = newHash;
                        lastActivitiesData = activitiesData.activities || [];
                        updateActivityFeed(lastActivitiesData);
                    }
                }

                // Only refresh modal if it's open and data might have changed
                const modal = document.getElementById('alertModal');
                if (modal && modal.classList.contains('show')) {
                    const persistedState = retrieveAlertModalState();
                    if (persistedState) {
                        // Check if the incident data has changed before refreshing modal
                        const currentIncident = locations.find(loc => String(loc.icd_id) === String(persistedState.incidentId));
                        if (currentIncident) {
                            // Only refresh if status or other key fields changed
                            const modalIncident = currentIncidentContext?.incident;
                            if (!modalIncident || 
                                modalIncident.icd_status !== currentIncident.icd_status ||
                                modalIncident.resolved_timestamp !== currentIncident.resolved_timestamp ||
                                modalIncident.pending_timestamp !== currentIncident.pending_timestamp ||
                                modalIncident.cancelled_timestamp !== currentIncident.cancelled_timestamp) {
                                // Use requestAnimationFrame to prevent flickering
                                requestAnimationFrame(() => {
                                    showAlertDetails(persistedState.incidentId, persistedState.userId);
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing dashboard data:', error);
                // Silently fail - don't disrupt user experience
            } finally {
                isRefreshing = false;
                if (indicator) {
                    setTimeout(() => indicator.classList.remove('show'), 600);
                }
            }
        }
        const MODAL_STORAGE_KEY = 'alertModalState';

        function persistAlertModalState(alertId, userId) {
            if (!alertId) {
                return;
            }
            try {
                const payload = {
                    incidentId: String(alertId),
                    userId: userId ? String(userId) : '',
                    storedAt: Date.now()
                };
                localStorage.setItem(MODAL_STORAGE_KEY, JSON.stringify(payload));
            } catch (error) {
                console.warn('Unable to persist alert modal state:', error);
            }
        }

        function clearAlertModalState() {
            try {
                localStorage.removeItem(MODAL_STORAGE_KEY);
            } catch (error) {
                console.warn('Unable to clear alert modal state:', error);
            }
        }

        function retrieveAlertModalState(maxAgeMs = 5 * 60 * 1000) {
            try {
                const raw = localStorage.getItem(MODAL_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!parsed || !parsed.incidentId) {
                    localStorage.removeItem(MODAL_STORAGE_KEY);
                    return null;
                }
                if (parsed.storedAt && (Date.now() - parsed.storedAt) > maxAgeMs) {
                    localStorage.removeItem(MODAL_STORAGE_KEY);
                    return null;
                }
                return parsed;
            } catch (error) {
                console.warn('Unable to retrieve alert modal state:', error);
                return null;
            }
        }
        
        // Dashboard Charts
        let alertTypesChart, alertsByTimeChart, falseAlertsChart;
        let studentRegisteredChart, alertsByCollegeChart, alertsByYearLevelChart;
        let currentDateRange = 'today';

        // Chart Toggle Functionality - Strict Single-View Mode
        function toggleChart(chartName) {
            // Get all chart containers and buttons
            const allContainers = document.querySelectorAll('.chart-container');
            const allButtons = document.querySelectorAll('.chart-toggle-btn');
            
            // Hide all charts
            allContainers.forEach(container => {
                container.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            allButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show only the selected chart
            const selectedContainer = document.querySelector(`.chart-container[data-chart="${chartName}"]`);
            const selectedButton = document.querySelector(`.chart-toggle-btn[data-chart="${chartName}"]`);
            
            if (selectedContainer) {
                selectedContainer.classList.remove('hidden');
            }
            
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        }

        // Initialize: Show only the first chart by default
        function initializeChartVisibility() {
            const allContainers = document.querySelectorAll('.chart-container');
            const allButtons = document.querySelectorAll('.chart-toggle-btn');
            
            // Hide all charts
            allContainers.forEach(container => {
                container.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            allButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show only the first chart (Alert Category)
            const firstContainer = document.querySelector('.chart-container[data-chart="alertCategory"]');
            const firstButton = document.querySelector('.chart-toggle-btn[data-chart="alertCategory"]');
            
            if (firstContainer) {
                firstContainer.classList.remove('hidden');
            }
            
            if (firstButton) {
                firstButton.classList.add('active');
            }
        }

        // Date filter functions
        function setDateFilter(dateRange) {
            currentDateRange = dateRange;
            
            // Update button styles
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            const activeBtn = document.getElementById(`filter-${dateRange}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
            }
            
            // Hide custom date inputs
            document.getElementById('custom-start-date').classList.add('hidden');
            document.getElementById('custom-end-date').classList.add('hidden');
            document.getElementById('apply-custom-date').classList.add('hidden');
            
            // Clear the last incidents hash to force map update with new date filter
            lastIncidentsHash = null;
            
            // Reload all charts and stats (all use buildApiUrl which includes date filter)
            loadDashboardStats();
            loadAlertTypesChart();
            loadAlertsByTimeChart();
            loadFalseAlertsChart();
            loadStudentRegisteredChart();
            loadAlertsByStudent();
            loadLocationDistribution();
            // Refresh map data with date filter (this will update the live map)
            refreshDashboardData();
        }

        function showCustomDateRange() {
            document.getElementById('custom-start-date').classList.remove('hidden');
            document.getElementById('custom-end-date').classList.remove('hidden');
            document.getElementById('apply-custom-date').classList.remove('hidden');
        }

        function applyCustomDateRange() {
            const startDate = document.getElementById('custom-start-date').value;
            const endDate = document.getElementById('custom-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            // Set custom date range
            currentDateRange = 'custom';
            
            // Update button styles
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // Clear the last incidents hash to force map update with new date filter
            lastIncidentsHash = null;
            
            // Reload all charts and stats with custom date range (all use buildApiUrl which includes date filter)
            loadDashboardStats();
            loadAlertTypesChart();
            loadAlertsByTimeChart();
            loadFalseAlertsChart();
            loadStudentRegisteredChart();
            loadAlertsByStudent();
            loadLocationDistribution();
            // Refresh map data with date filter (this will update the live map)
            refreshDashboardData();
        }

        function buildApiUrl(endpoint) {
            let url = `${endpoint}?date_range=${currentDateRange}`;
            if (currentDateRange === 'custom') {
                const startDate = document.getElementById('custom-start-date').value;
                const endDate = document.getElementById('custom-end-date').value;
                if (startDate && endDate) {
                    url += `&start_date=${startDate}&end_date=${endDate}`;
                }
            }
            return url;
        }

        async function loadDashboardStats() {
            try {
                const url = buildApiUrl('/api/dashboard/stats');
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    const totalAlertsEl = document.getElementById('total-alerts-count');
                    const resolvedEl = document.getElementById('resolved-count');
                    const avgTimeEl = document.getElementById('avg-response-time');
                    
                    if (totalAlertsEl) {
                        totalAlertsEl.textContent = result.stats.total_alerts || 0;
                    }
                    if (resolvedEl) {
                        resolvedEl.textContent = result.stats.resolved || 0;
                    }
                    if (avgTimeEl) {
                        const avgTime = result.stats.avg_response_time_minutes || 0;
                        avgTimeEl.textContent = avgTime > 0 ? `${Math.round(avgTime)} min` : '0 min';
                    }
                } else {
                    console.error('Failed to load dashboard stats:', result.error);
                    // Set default values on API error
                    setDefaultStats();
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Set default values on error
                setDefaultStats();
            }
        }
        
        function setDefaultStats() {
                const totalAlertsEl = document.getElementById('total-alerts-count');
                const resolvedEl = document.getElementById('resolved-count');
                const avgTimeEl = document.getElementById('avg-response-time');
                if (totalAlertsEl) totalAlertsEl.textContent = '0';
                if (resolvedEl) resolvedEl.textContent = '0';
                if (avgTimeEl) avgTimeEl.textContent = '0 min';
        }
        
        async function loadAlertCounts() {
            try {
                const response = await fetch('/api/alerts/count');
                const result = await response.json();
                if (result.success && result.counts) {
                    const activeCount = result.counts.active || 0;
                    const pendingCount = result.counts.pending || 0;
                    
                    // Update tooltip counts
                    const activeCountEl = document.getElementById('tooltipActiveCount');
                    const pendingCountEl = document.getElementById('tooltipPendingCount');
                    
                    if (activeCountEl) {
                        activeCountEl.textContent = activeCount;
                    }
                    if (pendingCountEl) {
                        pendingCountEl.textContent = pendingCount;
                    }
                }
            } catch (error) {
                console.error('Error loading alert counts:', error);
            }
        }
        
        function showAlertsTooltip(button) {
            const tooltip = document.getElementById('alertsTooltip');
            if (tooltip) {
                tooltip.classList.add('show');
                // Load counts if not already loaded
                loadAlertCounts();
            }
        }
        
        function hideAlertsTooltip(button) {
            const tooltip = document.getElementById('alertsTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        async function loadAlertTypesChart() {
            try {
                const url = buildApiUrl('/api/dashboard/alert-types');
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success && alertTypesChart) {
                    const labels = Object.keys(result.data || {});
                    const data = Object.values(result.data || {});
                    
                    // Map category names to their corresponding colors
                    function getCategoryColor(category) {
                        switch(category) {
                            case 'Urgent': return '#7c2d12';      // red-900
                            case 'Medical': return '#dc2626';      // red-600
                            case 'Security': return '#1e3a8a';     // blue-900
                            case 'University': return '#eab308';   // yellow-500
                            case 'Unknown': return '#4b5563';      // gray-600
                            default: return '#6b7280';            // gray-500 (fallback)
                        }
                    }
                    
                    // Create color array based on category labels
                    const colors = labels.map(label => getCategoryColor(label));
                    
                    if (labels.length === 0) {
                        alertTypesChart.data.labels = ['No Data'];
                        alertTypesChart.data.datasets[0].data = [0];
                        alertTypesChart.data.datasets[0].backgroundColor = ['#E5E7EB'];
                    } else {
                        alertTypesChart.data.labels = labels;
                        alertTypesChart.data.datasets[0].data = data;
                        alertTypesChart.data.datasets[0].backgroundColor = colors;
                    }
                    alertTypesChart.update();
                } else if (!result.success) {
                    console.error('Failed to load alert types:', result.error);
                }
            } catch (error) {
                console.error('Error loading alert types chart:', error);
            }
        }

        async function loadAlertsByTimeChart() {
            try {
                const url = buildApiUrl('/api/dashboard/alerts-by-time');
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success && alertsByTimeChart) {
                    if (result.data && result.data.labels && result.data.counts) {
                        // Validate data structure
                        if (Array.isArray(result.data.labels) && Array.isArray(result.data.counts) && 
                            result.data.labels.length === 24 && result.data.counts.length === 24) {
                            alertsByTimeChart.data.labels = result.data.labels;
                            alertsByTimeChart.data.datasets[0].data = result.data.counts;
                        } else {
                            console.warn('Invalid data structure for alerts by time chart, using default');
                            // Default 24-hour labels with zero data
                            alertsByTimeChart.data.labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                            alertsByTimeChart.data.datasets[0].data = Array(24).fill(0);
                        }
                    } else {
                        // Default 24-hour labels with zero data
                        alertsByTimeChart.data.labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                        alertsByTimeChart.data.datasets[0].data = Array(24).fill(0);
                    }
                    alertsByTimeChart.update();
                } else if (!result.success) {
                    console.error('Failed to load alerts by time:', result.error);
                    // Set default empty data on error
                    if (alertsByTimeChart) {
                        alertsByTimeChart.data.labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                        alertsByTimeChart.data.datasets[0].data = Array(24).fill(0);
                        alertsByTimeChart.update();
                    }
                }
            } catch (error) {
                console.error('Error loading alerts by time chart:', error);
                // Set default empty data on error
                if (alertsByTimeChart) {
                    alertsByTimeChart.data.labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                    alertsByTimeChart.data.datasets[0].data = Array(24).fill(0);
                    alertsByTimeChart.update();
                }
            }
        }

        async function loadStudentRegisteredChart() {
            try {
                const url = buildApiUrl('/api/dashboard/student-registered');
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success && studentRegisteredChart) {
                    const labels = Object.keys(result.data || {});
                    const data = Object.values(result.data || {});
                    const colors = ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B', '#3B82F6', '#EF4444', '#06B6D4', '#84CC16'];
                    
                    if (labels.length === 0) {
                        studentRegisteredChart.data.labels = ['No Data'];
                        studentRegisteredChart.data.datasets[0].data = [0];
                        studentRegisteredChart.data.datasets[0].backgroundColor = ['#E5E7EB'];
                    } else {
                        studentRegisteredChart.data.labels = labels;
                        studentRegisteredChart.data.datasets[0].data = data;
                        studentRegisteredChart.data.datasets[0].backgroundColor = colors.slice(0, labels.length);
                    }
                    studentRegisteredChart.update();
                } else if (!result.success) {
                    console.error('Failed to load student registered:', result.error);
                }
            } catch (error) {
                console.error('Error loading student registered chart:', error);
            }
        }

        async function loadAlertsByStudent() {
            try {
                const url = buildApiUrl('/api/dashboard/alerts-by-student');
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    // Update alerts by college chart
                    if (alertsByCollegeChart) {
                        if (result.data && result.data.by_college && Object.keys(result.data.by_college).length > 0) {
                            const labels = Object.keys(result.data.by_college);
                            const data = Object.values(result.data.by_college);
                            alertsByCollegeChart.data.labels = labels;
                            alertsByCollegeChart.data.datasets[0].data = data;
                        } else {
                            alertsByCollegeChart.data.labels = ['No Data'];
                            alertsByCollegeChart.data.datasets[0].data = [0];
                        }
                        alertsByCollegeChart.update();
                    }
                    
                    // Update alerts by year level chart
                    if (alertsByYearLevelChart) {
                        if (result.data && result.data.by_yearlvl && Object.keys(result.data.by_yearlvl).length > 0) {
                            const labels = Object.keys(result.data.by_yearlvl);
                            const data = Object.values(result.data.by_yearlvl);
                            alertsByYearLevelChart.data.labels = labels;
                            alertsByYearLevelChart.data.datasets[0].data = data;
                        } else {
                            alertsByYearLevelChart.data.labels = ['No Data'];
                            alertsByYearLevelChart.data.datasets[0].data = [0];
                        }
                        alertsByYearLevelChart.update();
                    }
                } else if (!result.success) {
                    console.error('Failed to load alerts by student:', result.error);
                }
            } catch (error) {
                console.error('Error loading alerts by student:', error);
            }
        }

        async function loadLocationDistribution() {
            const onCampusEl = document.getElementById('location-on-campus-count');
            const externalEl = document.getElementById('location-external-count');
            if (!onCampusEl || !externalEl) return;
            
            try {
                const url = buildApiUrl('/api/dashboard/location-distribution');
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.success && result.data) {
                    onCampusEl.textContent = result.data.on_campus ?? 0;
                    externalEl.textContent = result.data.external ?? 0;
                } else {
                    onCampusEl.textContent = '0';
                    externalEl.textContent = '0';
                }
            } catch (error) {
                console.error('Error loading location distribution:', error);
                onCampusEl.textContent = '0';
                externalEl.textContent = '0';
            }
        }


        async function loadFalseAlertsChart() {
            try {
                const url = buildApiUrl('/api/dashboard/false-alerts');
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success && falseAlertsChart) {
                    const valid = result.data?.valid || 0;
                    const falseAlerts = result.data?.false || 0;
                    falseAlertsChart.data.datasets[0].data = [valid, falseAlerts];
                    falseAlertsChart.update();
                } else if (!result.success) {
                    console.error('Failed to load false alerts:', result.error);
                }
            } catch (error) {
                console.error('Error loading false alerts chart:', error);
            }
        }

        function initializeDashboardCharts() {
            // Register Chart.js DataLabels plugin if available
            if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
                Chart.register(ChartDataLabels);
            }
            
            // Alert Types Pie Chart
            const alertTypesCtx = document.getElementById('alertTypesChart');
            if (alertTypesCtx) {
                alertTypesChart = new Chart(alertTypesCtx, {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#7c2d12', '#dc2626', '#1e3a8a', '#eab308', '#4b5563'] // Urgent, Medical, Security, University, Unknown
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: (value, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return value > 0 ? `${value}\n(${percentage}%)` : '';
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Alerts by Time of Day Bar Chart
            const alertsByTimeCtx = document.getElementById('alertsByTimeChart');
            if (alertsByTimeCtx) {
                alertsByTimeChart = new Chart(alertsByTimeCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Alerts',
                            data: [],
                            backgroundColor: '#F59E0B',
                            borderColor: '#D97706',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Alerts: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: {
                                        size: 9
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Student Registered Pie Chart
            const studentRegisteredCtx = document.getElementById('studentRegisteredChart');
            if (studentRegisteredCtx) {
                studentRegisteredChart = new Chart(studentRegisteredCtx, {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B', '#3B82F6', '#EF4444', '#06B6D4', '#84CC16']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 10
                                },
                                formatter: (value, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return value > 0 ? `${value}\n(${percentage}%)` : '';
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
            
            // Alerts by College Bar Chart
            const alertsByCollegeCtx = document.getElementById('alertsByCollegeChart');
            if (alertsByCollegeCtx) {
                alertsByCollegeChart = new Chart(alertsByCollegeCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Alerts',
                            data: [],
                            backgroundColor: '#10B981',
                            borderColor: '#059669',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Alerts: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }
            
            // Alerts by Year Level Bar Chart
            const alertsByYearLevelCtx = document.getElementById('alertsByYearLevelChart');
            if (alertsByYearLevelCtx) {
                alertsByYearLevelChart = new Chart(alertsByYearLevelCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Alerts',
                            data: [],
                            backgroundColor: '#6366F1',
                            borderColor: '#4F46E5',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Alerts: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            // False Alerts Donut Chart
            const falseAlertsCtx = document.getElementById('falseAlertsChart');
            if (falseAlertsCtx) {
                falseAlertsChart = new Chart(falseAlertsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Valid', 'False'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['#10B981', '#EF4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: (value, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    if (total === 0) return '';
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return value > 0 ? `${value}\n(${percentage}%)` : '';
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Load all data
            loadDashboardStats();
            loadAlertTypesChart();
            loadAlertsByTimeChart();
            loadFalseAlertsChart();
            loadStudentRegisteredChart();
            loadAlertsByStudent();
            loadAlertCounts(); // Load alert counts for tooltip
            loadLocationDistribution();
        }
        
        // Initialize map
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeDashboardCharts();
            initializeChartVisibility();
            
            document.querySelectorAll('img[data-fallback-src]').forEach(img => {
                img.addEventListener('error', () => {
                    const fallbackSrc = img.getAttribute('data-fallback-src');
                    if (fallbackSrc && img.src !== fallbackSrc) {
                        img.onerror = null;
                        img.src = fallbackSrc;
                    }
                });
            });

            wireAlertCardEvents();

            const persistedModalState = retrieveAlertModalState();
            if (persistedModalState) {
                setTimeout(() => {
                    showAlertDetails(persistedModalState.incidentId, persistedModalState.userId);
                }, 450);
            }

            const resolutionSummaryForm = document.getElementById('resolutionSummaryForm');
            if (resolutionSummaryForm) {
                resolutionSummaryForm.addEventListener('submit', function() {
                    clearAlertModalState();
                    const submitButton = document.getElementById('resolutionSummarySubmitBtn');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.textContent = 'Submitting...';
                    }
                });
            }

            const resolutionSummaryInput = document.getElementById('resolutionSummaryInput');
            if (resolutionSummaryInput) {
                resolutionSummaryInput.addEventListener('input', updateResolutionSummaryCharCount);
                updateResolutionSummaryCharCount();
            }

            // Handle window resize for responsive map
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (map) {
                        map.invalidateSize();
                    }
                    if (modalMap) {
                        modalMap.invalidateSize();
                    }
                }, 250);
            });

            refreshDashboardData();
            
            // Smart refresh - pause when user is interacting
            let userActive = false;
            let refreshInterval = null;
            let refreshTimeout = null;
            
            const startRefresh = () => {
                if (refreshInterval) return;
                refreshInterval = setInterval(() => {
                    if (!userActive && !document.hidden && !isRefreshing) {
                        refreshDashboardData();
                    }
                }, REFRESH_INTERVAL_MS);
            };
            
            const stopRefresh = () => {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                if (refreshTimeout) {
                    clearTimeout(refreshTimeout);
                    refreshTimeout = null;
                }
            };
            
            // Track user activity with debouncing
            let activityTimeout;
            const resetActivity = () => {
                userActive = true;
                clearTimeout(activityTimeout);
                activityTimeout = setTimeout(() => {
                    userActive = false;
                }, 5000); // Consider user inactive after 5 seconds
            };
            
            // Monitor user interactions (with throttling for scroll)
            let scrollTimeout;
            ['mousedown', 'mousemove', 'keypress', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetActivity, { passive: true });
            });
            
            // Throttle scroll events
            document.addEventListener('scroll', () => {
                resetActivity();
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    // Allow refresh after scroll stops
                }, 1000);
            }, { passive: true });
            
            // Pause when page is hidden
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopRefresh();
                } else {
                    startRefresh();
                    // Debounce refresh when page becomes visible
                    if (refreshTimeout) clearTimeout(refreshTimeout);
                    refreshTimeout = setTimeout(() => {
                        refreshDashboardData(); // Refresh after a short delay when page becomes visible
                    }, 500);
                }
            });
            
            startRefresh();
        });
        
        function printIncidentHistory() {
            const historyElements = Array.from(document.querySelectorAll('.activity-item[data-incident]'));
            if (historyElements.length === 0) {
                alert('No incident history available to print.');
                return;
            }

            const decodeHtml = (value = '') => {
                const txt = document.createElement('textarea');
                txt.innerHTML = value;
                return txt.value;
            };

            const escapeHtml = (unsafe = '') => String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            const parseValue = (value, fallback = '') => {
                const decoded = decodeHtml(value || '').trim();
                return decoded || fallback;
            };

            const formatMultiline = (value = '') => escapeHtml(value).replace(/\n/g, '<br>');

            const formatSummaryLabel = (value = '', fallback = 'Unspecified') => {
                const text = String(value || '').trim();
                if (!text) {
                    return fallback;
                }
                if (text.toUpperCase() === 'N/A') {
                    return 'N/A';
                }
                if (text === '—') {
                    return fallback;
                }
                return text
                    .toLowerCase()
                    .split(/\s+/)
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                    .join(' ');
            };

            const now = new Date();
            const generatedAt = now.toLocaleString('en-PH', {
                timeZone: 'Asia/Manila',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            }).replace(',', ' at');

            const logoCCIS = "{{ url_for('static', filename='images/ccis.png') }}";
            const logoOHSO = "{{ url_for('static', filename='images/ohso.png') }}";

            const incidents = historyElements.map((item, index) => {
                const data = item.dataset;

                const incidentId = parseValue(data.incident, '—');
                const eventLabel = parseValue(data.eventLabel, '—');
                const eventType = parseValue(data.eventType, '—');
                const statusRaw = parseValue(data.status, 'Unspecified');
                const statusSummary = statusRaw && statusRaw !== '—' ? statusRaw : 'Unspecified';
                const occurredDisplay = parseValue(data.occurred, 'Not specified');
                const occurredIso = parseValue(data.occurredIso, '');
                const previousStatus = parseValue(data.previousStatus, '—');
                const student = parseValue(data.student, '—');
                const categoryRaw = parseValue(data.category, 'N/A');
                const categorySummary = (!categoryRaw || categoryRaw === '—' || categoryRaw === 'N/A')
                    ? 'Unspecified'
                    : categoryRaw;
                const actorName = parseValue(data.actor);
                const actorRole = parseValue(data.actorRole);
                const reason = parseValue(data.reason);
                const description = parseValue(data.description);

                const actorInfo = actorName
                    ? `<div class="primary">${escapeHtml(actorName)}</div>${actorRole ? `<div class="secondary">${escapeHtml(actorRole)}</div>` : ''}`
                    : '—';

                const reasonHtml = reason
                    ? `<div class="meta"><strong>Reason:</strong> ${formatMultiline(reason)}</div>`
                    : '';
                const descriptionHtml = description
                    ? `<div class="meta"><strong>Description:</strong> ${formatMultiline(description)}</div>`
                    : '';
                const detailRow = reasonHtml || descriptionHtml
                    ? `<tr class="detail-row"><td colspan="9">${reasonHtml}${descriptionHtml}</td></tr>`
                    : '';

                const parsedOccurred = (() => {
                    if (occurredIso) {
                        const isoDate = new Date(occurredIso);
                        if (!Number.isNaN(isoDate.getTime())) {
                            return isoDate;
                        }
                    }
                    const fallbackDate = new Date(occurredDisplay);
                    if (!Number.isNaN(fallbackDate.getTime())) {
                        return fallbackDate;
                    }
                    return null;
                })();

                return {
                    index,
                    incidentId,
                    eventLabel,
                    eventType,
                    statusRaw,
                    statusSummary,
                    occurredDisplay,
                    occurredIso,
                    parsedOccurred,
                    student,
                    actorName,
                    actorRole,
                    categoryRaw,
                    categorySummary,
                    previousStatus,
                    reason,
                    description,
                    rowHtml: `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${escapeHtml(incidentId)}</td>
                            <td>${escapeHtml(student)}</td>
                            <td>${escapeHtml(categoryRaw)}</td>
                            <td>${escapeHtml(statusRaw)}</td>
                            <td>${escapeHtml(occurredDisplay)}</td>
                            <td>
                                <div class="primary">${escapeHtml(eventLabel)}</div>
                                <div class="secondary">${escapeHtml(eventType)}</div>
                            </td>
                            <td>${escapeHtml(previousStatus)}</td>
                            <td>${actorInfo}</td>
                        </tr>
                        ${detailRow}
                    `
                };
            });

            const totalEvents = incidents.length;

            const statusCounts = incidents.reduce((acc, incident) => {
                const key = incident.statusSummary || 'Unspecified';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const statusEntries = Object.entries(statusCounts)
                .map(([status, count]) => ({
                    raw: status,
                    label: formatSummaryLabel(status),
                    count
                }))
                .sort((a, b) => b.count - a.count || a.label.localeCompare(b.label));

            const categoryCounts = incidents.reduce((acc, incident) => {
                const key = incident.categorySummary || 'Unspecified';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const categoryEntries = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    raw: category,
                    label: formatSummaryLabel(category),
                    count
                }))
                .sort((a, b) => b.count - a.count || a.label.localeCompare(b.label));

            const meaningfulCategoryEntries = categoryEntries.filter(entry => entry.label !== 'Unspecified');

            const validDates = incidents
                .map(incident => incident.parsedOccurred)
                .filter(date => date instanceof Date && !Number.isNaN(date.getTime()))
                .sort((a, b) => a.getTime() - b.getTime());

            const periodStart = validDates[0] || null;
            const periodEnd = validDates[validDates.length - 1] || null;

            const formatDateForSummary = (date) => date.toLocaleString('en-PH', {
                timeZone: 'Asia/Manila',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            }).replace(',', ' at');

            const periodRange = periodStart && periodEnd
                ? `${formatDateForSummary(periodStart)} – ${formatDateForSummary(periodEnd)}`
                : '';

            const headerPeriodLine = periodRange
                ? `<div><strong>Report Period:</strong> ${escapeHtml(periodRange)}</div>`
                : '';

            const latestIncident = incidents
                .slice()
                .sort((a, b) => {
                    const bTime = b.parsedOccurred ? b.parsedOccurred.getTime() : 0;
                    const aTime = a.parsedOccurred ? a.parsedOccurred.getTime() : 0;
                    return bTime - aTime;
                })
                .find(item => item.parsedOccurred);

            const topStatus = statusEntries[0] || null;
            const topCategory = meaningfulCategoryEntries[0] || null;

            const totalPhrase = totalEvents === 1
                ? '1 incident update recorded'
                : `${totalEvents} incident updates recorded`;
            const summaryIntro = `This report consolidates ${totalPhrase}${periodRange ? ` between ${periodRange}` : ''} through the UMAK Emergency Alert System.`;
            const latestSentence = latestIncident
                ? ` The most recent update was logged on ${latestIncident.occurredDisplay} for ${latestIncident.incidentId}${latestIncident.statusSummary ? ` (${formatSummaryLabel(latestIncident.statusSummary)})` : ''}.`
                : '';
            const statusSentence = statusEntries.length
                ? ` Status distribution: ${statusEntries.map(entry => `${entry.label} (${entry.count})`).join('; ')}.`
                : '';
            const summaryParagraph = escapeHtml(`${summaryIntro}${latestSentence}${statusSentence}`.trim());

            const summaryMetricsData = [
                {
                    label: 'Total Logged Events',
                    value: `${totalEvents}`,
                    subtext: statusEntries.length
                        ? `${statusEntries.length} status classification${statusEntries.length === 1 ? '' : 's'}`
                        : ''
                },
                periodRange ? {
                    label: 'Report Coverage',
                    value: periodRange,
                    subtext: `Data as of ${generatedAt}`
                } : null,
                latestIncident ? {
                    label: 'Most Recent Update',
                    value: latestIncident.occurredDisplay,
                    subtext: `${latestIncident.incidentId}${latestIncident.statusSummary ? ` · ${formatSummaryLabel(latestIncident.statusSummary)}` : ''}`
                } : null,
                topStatus ? {
                    label: 'Predominant Status',
                    value: topStatus.label,
                    subtext: `${topStatus.count} record${topStatus.count === 1 ? '' : 's'}`
                } : null,
                topCategory ? {
                    label: 'Most Reported Category',
                    value: topCategory.label,
                    subtext: `${topCategory.count} record${topCategory.count === 1 ? '' : 's'}`
                } : null
            ].filter(Boolean);

            const summaryMetricsHtml = summaryMetricsData.length
                ? `
                    <div class="summary-metrics">
                        ${summaryMetricsData.map(metric => `
                            <div class="summary-metric">
                                <div class="summary-metric-label">${escapeHtml(metric.label)}</div>
                                <div class="summary-metric-value">${escapeHtml(metric.value)}</div>
                                ${metric.subtext ? `<div class="summary-metric-subtext">${escapeHtml(metric.subtext)}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `
                : '';

            const statusPillsSection = statusEntries.length
                ? `
                    <div class="summary-subsection">
                        <div class="summary-section-title">Status Distribution</div>
                        <div class="summary-pills">
                            ${statusEntries.map(entry => `<span class="summary-pill"><strong>${escapeHtml(entry.label)}</strong> ${escapeHtml(String(entry.count))}</span>`).join(' ')}
                        </div>
                    </div>
                `
                : '';

            const categoryPillsSection = meaningfulCategoryEntries.length
                ? `
                    <div class="summary-subsection">
                        <div class="summary-section-title">Category Mix</div>
                        <div class="summary-pills">
                            ${meaningfulCategoryEntries.map(entry => `<span class="summary-pill summary-pill--neutral"><strong>${escapeHtml(entry.label)}</strong> ${escapeHtml(String(entry.count))}</span>`).join(' ')}
                        </div>
                    </div>
                `
                : '';

            const summarySection = `
                <section class="summary">
                    <div class="summary-header">
                        <h2>Incident Summary</h2>
                        <p>${summaryParagraph}</p>
                    </div>
                    ${summaryMetricsHtml}
                    ${statusPillsSection}
                    ${categoryPillsSection}
                </section>
            `;

            const rows = incidents.map(incident => incident.rowHtml).join('');

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Incident History Report</title>
                    <style>
                        @page { margin: 0.75in; }
                        body {
                            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, sans-serif;
                            color: #1f2937;
                            background: white;
                            margin: 0;
                            padding: 0;
                        }
                        .report-container {
                            padding: 0.5rem 0 2rem 0;
                        }
                        .doc-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-bottom: 2px solid #1f2937;
                            padding-bottom: 1rem;
                            margin-bottom: 1.5rem;
                        }
                        .branding {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        }
                        .branding img {
                            height: 48px;
                            width: 48px;
                            object-fit: contain;
                        }
                        .branding h1 {
                            margin: 0;
                            font-size: 1.1rem;
                            text-transform: uppercase;
                            letter-spacing: 0.08em;
                        }
                        .branding p {
                            margin: 0.2rem 0 0;
                            font-size: 0.85rem;
                            color: #4b5563;
                        }
                        .report-meta {
                            text-align: right;
                            font-size: 0.8rem;
                            color: #374151;
                            line-height: 1.4;
                        }
                        .summary {
                            background: #f9fafb;
                            border: 1px solid #e5e7eb;
                            border-radius: 0.85rem;
                            padding: 1.25rem;
                            margin-bottom: 1.5rem;
                        }
                        .summary h2 {
                            margin: 0;
                            font-size: 1rem;
                            text-transform: uppercase;
                            letter-spacing: 0.08em;
                            color: #111827;
                        }
                        .summary p {
                            margin: 0.65rem 0 1.1rem;
                            font-size: 0.82rem;
                            line-height: 1.5;
                            color: #374151;
                        }
                        .summary-metrics {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                            gap: 0.85rem;
                            margin-bottom: 1rem;
                        }
                        .summary-metric {
                            background: #ffffff;
                            border: 1px solid #e5e7eb;
                            border-radius: 0.75rem;
                            padding: 0.8rem;
                        }
                        .summary-metric-label {
                            font-size: 0.65rem;
                            letter-spacing: 0.08em;
                            text-transform: uppercase;
                            color: #6b7280;
                            margin-bottom: 0.35rem;
                        }
                        .summary-metric-value {
                            font-size: 0.92rem;
                            font-weight: 600;
                            color: #111827;
                        }
                        .summary-metric-subtext {
                            margin-top: 0.3rem;
                            font-size: 0.7rem;
                            color: #6b7280;
                        }
                        .summary-subsection {
                            margin-top: 1rem;
                        }
                        .summary-section-title {
                            font-size: 0.68rem;
                            letter-spacing: 0.08em;
                            text-transform: uppercase;
                            color: #6b7280;
                            margin-bottom: 0.5rem;
                        }
                        .summary-pills {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.5rem;
                        }
                        .summary-pill {
                            display: inline-flex;
                            align-items: center;
                            gap: 0.4rem;
                            background: #1f2937;
                            color: #ffffff;
                            border-radius: 9999px;
                            padding: 0.4rem 0.85rem;
                            font-size: 0.72rem;
                            font-weight: 500;
                            letter-spacing: 0.02em;
                        }
                        .summary-pill.summary-pill--neutral {
                            background: #e5e7eb;
                            color: #111827;
                        }
                        .summary-pill strong {
                            font-weight: 700;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 0.8rem;
                            table-layout: fixed;
                        }
                        thead tr {
                            background: #1f2937;
                            color: white;
                        }
                        th, td {
                            border: 1px solid #d1d5db;
                            padding: 0.55rem 0.45rem;
                            text-align: left;
                            vertical-align: top;
                            word-wrap: break-word;
                        }
                        th {
                            font-size: 0.72rem;
                            letter-spacing: 0.04em;
                            text-transform: uppercase;
                        }
                        tbody tr:nth-child(odd) {
                            background: #f9fafb;
                        }
                        .primary {
                            font-weight: 600;
                            color: #111827;
                        }
                        .secondary {
                            font-size: 0.7rem;
                            color: #6b7280;
                        }
                        .detail-row td {
                            background: #f1f5f9;
                            font-size: 0.75rem;
                            line-height: 1.4;
                        }
                        .meta {
                            margin-bottom: 0.3rem;
                        }
                        .meta:last-child {
                            margin-bottom: 0;
                        }
                        .doc-footer {
                            margin-top: 2rem;
                            padding-top: 1rem;
                            border-top: 1px solid #d1d5db;
                            font-size: 0.7rem;
                            color: #6b7280;
                            text-align: center;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <header class="doc-header">
                            <div class="branding">
                                <img src="${logoCCIS}" alt="CCIS Logo" onerror="this.style.display='none'">
                                <img src="${logoOHSO}" alt="OHSO Logo" onerror="this.style.display='none'">
                                <div>
                                    <h1>University of Makati</h1>
                                    <p>Emergency Alert System – Incident History Report</p>
                                </div>
                            </div>
                            <div class="report-meta">
                                <div><strong>Generated:</strong> ${generatedAt}</div>
                                <div><strong>Total Events:</strong> ${totalEvents}</div>
                                ${headerPeriodLine}
                            </div>
                        </header>
                        ${summarySection}
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>icd_id</th>
                                    <th>student</th>
                                    <th>Category</th>
                                    <th>status</th>
                                    <th>time reported</th>
                                    <th>EVENT</th>
                                    <th>PREV. STATUS</th>
                                    <th>Assign to</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        <footer class="doc-footer">
                            UMAK Emergency Alert System · Generated automatically by the admin dashboard.
                        </footer>
                    </div>
                </body>
                </html>
            `;

            const printFrame = document.createElement('iframe');
            printFrame.style.position = 'fixed';
            printFrame.style.right = '0';
            printFrame.style.bottom = '0';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = '0';
            document.body.appendChild(printFrame);

            const frameDoc = printFrame.contentWindow || printFrame.contentDocument;
            frameDoc.document.open();
            frameDoc.document.write(reportHtml);
            frameDoc.document.close();

            printFrame.onload = function() {
                try {
                    frameDoc.focus();
                    frameDoc.print();
                } finally {
                    setTimeout(() => document.body.removeChild(printFrame), 1000);
                }
            };
        }

        function initializeMap() {
            map = L.map('map').setView([UMAK_LAT, UMAK_LNG], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);
            
            // UMAK marker
            const umakIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            
            L.marker([UMAK_LAT, UMAK_LNG], {icon: umakIcon}).addTo(map)
                .bindPopup("<b>University of Makati</b><br>Main Campus");
            
            // Add 500-meter blue circle around UMAK
            umakCircle = L.circle([UMAK_LAT, UMAK_LNG], {
                color: '#3b82f6',       // Blue border
                fillColor: '#3b82f6',   // Blue fill
                fillOpacity: 0.2,       // Semi-transparent
                radius: 500,            // 500 meters
                weight: 2               // Border thickness
            }).addTo(map);
            
            umakCircle.bindPopup("<b>UMAK Campus Radius</b><br>500 meter coverage area");
            
            // Add incident markers
            addIncidentMarkers();
        }
        
        async function addIncidentMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Process markers in parallel for better performance
            const markerPromises = locations.map(async function(location) {
                // Validate and use coordinates, fallback to UMAK if invalid
                let lat = parseFloat(location.icd_lat);
                let lng = parseFloat(location.icd_lng);
                
                // Check if coordinates are valid numbers and within reasonable bounds
                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    lat = UMAK_LAT;
                    lng = UMAK_LNG;
                }
                
                await addIncidentMarker(
                    lat, 
                    lng, 
                    location.icd_status, 
                    location.icd_id, 
                    location.user_id, 
                    location.icd_category || 'Unknown', 
                    location.icd_timestamp
                );
            });
            
            // Wait for all markers to be added
            await Promise.all(markerPromises);
        }
        
        async function addIncidentMarker(lat, lng, status, incidentId, userId, category, timestamp) {
            const markerColor = status === 'Active' ? 'red' : 
                              status === 'Pending' ? 'orange' : 
                              status === 'Resolved' ? 'green' : 'grey';
            
            const markerIcon = L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${markerColor}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            
            const marker = L.marker([lat, lng], {icon: markerIcon}).addTo(map);
            marker.status = status;
            marker.incidentId = incidentId;
            marker.userId = userId;
            
            // Add flashing animation to Active markers
            if (status === 'Active') {
                setTimeout(() => {
                    const markerElement = marker.getElement();
                    if (markerElement) {
                        // Apply animation class to marker container - animation uses opacity/filter only, no transform
                        markerElement.classList.add('active-marker-flash');
                    }
                }, 100);
            }
            
            const distance = calculateDistance(UMAK_LAT, UMAK_LNG, lat, lng);
            const distanceText = formatDistance(distance);
            
            // Find student name from incident data - handle string IDs
            // Get full_name from accounts_student table (via student_full_name field)
            const student = locations.find(loc => String(loc.icd_id) === String(incidentId));
            const studentName = student && student.student_full_name ? 
                              student.student_full_name : 
                              (student && (student.student_name || student.full_name) ? 
                               (student.student_name || student.full_name) : 'Unknown Student');
            const incidentIdString = incidentId !== undefined && incidentId !== null ? String(incidentId) : '';
            const safeIncidentId = incidentIdString.replace(/"/g, '\\"');
            
            // Extract numeric part from ICD ID for display
            const displayId = typeof incidentId === 'string' ? 
                             incidentId.replace('ICD', '') : incidentId;
            
            // Function to create popup content (reusable for updates)
            function createPopupContent(locationName) {
            const locationDisplay = locationName ? 
                "<div style='padding: 6px 0; margin: 4px 0; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;'>" +
                "<div style='padding: 2px 0;'><b>📍 Location Name:</b></div>" +
                "<div style='padding: 2px 0; color: #3b82f6; font-weight: 600; font-size: 13px;'>" + locationName + "</div>" +
                "<div style='padding: 2px 0; font-size: 10px; color: #6b7280; margin-top: 2px;'>Coordinates: " + lat.toFixed(6) + ", " + lng.toFixed(6) + "</div>" +
                "</div>" :
                "<div style='padding: 4px 0; margin: 4px 0; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;'>" +
                "<div style='padding: 2px 0;'><b>🌍 Coordinates:</b></div>" +
                "<div style='padding: 2px 0; font-size: 12px; color: #6b7280;'>" + lat.toFixed(6) + ", " + lng.toFixed(6) + "</div>" +
                "</div>";
            
                return "<div style='min-width: 280px; font-family: Inter, sans-serif;'>" +
                "<div style='background: linear-gradient(135deg, " + (status === 'Active' ? '#ef4444' : status === 'Pending' ? '#f59e0b' : status === 'Resolved' ? '#10b981' : '#6b7280') + ", " + (status === 'Active' ? '#dc2626' : status === 'Pending' ? '#d97706' : status === 'Resolved' ? '#059669' : '#4b5563') + "); color: white; padding: 8px 12px; margin: -12px -12px 8px -12px; border-radius: 12px 12px 0 0; font-weight: 600;'>" +
                "<b>📍 ICD_" + displayId + "</b> - " + status + " " + (category === 'Urgent' ? '🚨' : category === 'Medical' ? '🏥' : category === 'Security' ? '🛡️' : category === 'University' ? '🏫' : '⚠️') +
                "</div>" +
                "<div style='padding: 4px 0;'><b>👤 Student:</b> " + studentName + "</div>" +
                "<div style='padding: 4px 0;'><b>📊 Status:</b> <span style='color: " + (status === 'Active' ? '#ef4444' : status === 'Pending' ? '#f59e0b' : status === 'Resolved' ? '#10b981' : '#6b7280') + "; font-weight: 600;'>" + status + "</span></div>" +
                "<div style='padding: 4px 0;'><b>🏷️ Category:</b> " + category + "</div>" +
                locationDisplay +
                "<div style='padding: 4px 0;'><b>📏 Distance:</b> " + distanceText + " from UMAK</div>" +
                "<div style='padding: 4px 0;'><b>🕒 Time:</b> " + new Date(timestamp).toLocaleString('en-US', { timeZone: 'Asia/Manila' }) + "</div>" +
                "<div style='margin-top: 8px; display: flex; gap: 4px;'>" +
                "<button onclick='showAlertDetails(\"" + incidentId + "\", \"" + userId + "\")' style='flex: 1; background: #3b82f6; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.2s;'>📋 View Details</button>" +
                "<button onclick='startChatWithStudent(\"" + userId + "\", \"" + studentName.replace(/"/g, '\\"') + "\", \"" + safeIncidentId + "\"); map.closePopup();' style='flex: 1; background: #10b981; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.2s;'>💬 Chat</button>" +
                "</div>" +
                    "</div>";
            }
            
            // Create popup with coordinates first (location name will be added asynchronously)
            marker.bindPopup(createPopupContent(null));
            
            markers.push(marker);
            
            // Fetch location name asynchronously (non-blocking) and update popup when ready
            getLocationName(lat, lng).then(locationName => {
                if (locationName) {
                    // Update popup content with location name
                    marker.setPopupContent(createPopupContent(locationName));
                }
            }).catch(() => {
                // Silently fail - coordinates are already shown
            });
        }
        
        function filterMarkers(status) {
            currentFilter = status;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(status === 'all' ? 'allFilter' : status.toLowerCase() + 'Filter').classList.add('active');
            
            markers.forEach(marker => {
                if (status === 'all' || marker.status === status) {
                    marker.addTo(map);
                    // Re-apply flashing animation to Active markers when they become visible
                    if (marker.status === 'Active') {
                        setTimeout(() => {
                            const markerElement = marker.getElement();
                            if (markerElement) {
                                markerElement.classList.add('active-marker-flash');
                            }
                        }, 100);
                    }
                } else {
                    map.removeLayer(marker);
                }
            });
        }
        
        function recenterMap() {
            map.setView([UMAK_LAT, UMAK_LNG], 15);
            
            // Add a subtle animation feedback
            const recenterBtn = document.getElementById('recenterBtn');
            recenterBtn.classList.add('pulse');
            setTimeout(() => {
                recenterBtn.classList.remove('pulse');
            }, 600);
        }
        
        // Alert filtering functionality
        function filterAlertsByCategory(category, button) {
            currentAlertCategory = category;

            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (button && button.classList) {
                document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            } else {
                const matchedButton = document.querySelector(`.category-filter-btn[data-category="${category}"]`);
                if (matchedButton) {
                    matchedButton.classList.add('active');
                }
            }

            const alertCards = document.querySelectorAll('.emergency-card');
            alertCards.forEach(card => {
                const cardCategory = card.dataset.category || 'Unknown';
                card.style.display = (category === 'all' || cardCategory === category) ? 'block' : 'none';
            });
        }
        
        // Function to highlight alert notifications when alerts button is clicked
        function highlightAlertNotifications() {
            const alertSection = document.getElementById('alertNotificationsSection');
            const liveMapSection = document.getElementById('liveMapSection');
            
            // Highlight alert notifications section
            if (alertSection) {
                // Scroll to the alert notifications section
                alertSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Add highlight animation
                alertSection.style.transition = 'all 0.3s ease';
                alertSection.style.border = '3px solid #ef4444';
                alertSection.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
                alertSection.style.backgroundColor = '#fef2f2';
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    alertSection.style.border = '';
                    alertSection.style.boxShadow = '';
                    alertSection.style.backgroundColor = '';
                }, 3000);
                
                // Also highlight the first alert card if available
                const firstAlert = document.querySelector('.emergency-card');
                if (firstAlert) {
                    firstAlert.style.transition = 'all 0.3s ease';
                    firstAlert.style.border = '2px solid #ef4444';
                    firstAlert.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.4)';
                    setTimeout(() => {
                        firstAlert.style.border = '';
                        firstAlert.style.boxShadow = '';
                    }, 3000);
                }
            }
            
            // Highlight live map section
            if (liveMapSection) {
                // Scroll to the live map section (with a slight delay to show both highlights)
                setTimeout(() => {
                    liveMapSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
                
                // Add highlight animation
                liveMapSection.style.transition = 'all 0.3s ease';
                liveMapSection.style.border = '3px solid #ef4444';
                liveMapSection.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
                liveMapSection.style.backgroundColor = '#fef2f2';
                
                // Also highlight the map container
                const mapContainer = document.getElementById('map-container');
                if (mapContainer) {
                    mapContainer.style.transition = 'all 0.3s ease';
                    mapContainer.style.border = '2px solid #ef4444';
                    mapContainer.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.4)';
                }
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    liveMapSection.style.border = '';
                    liveMapSection.style.boxShadow = '';
                    liveMapSection.style.backgroundColor = '';
                    if (mapContainer) {
                        mapContainer.style.border = '';
                        mapContainer.style.boxShadow = '';
                    }
                }, 3000);
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function formatDistance(distance) {
            if (distance < 1) {
                return (distance * 1000).toFixed(0) + ' meters';
            } else {
                return distance.toFixed(2) + ' km';
            }
        }
        
        // Location name cache and rate limiting
        const locationNameCache = new Map();
        const locationNameQueue = [];
        let isProcessingLocationQueue = false;
        const LOCATION_CACHE_KEY_PRECISION = 4; // Round to 4 decimal places for cache key
        
        // Helper to create cache key from coordinates
        function getLocationCacheKey(lat, lng) {
            return `${lat.toFixed(LOCATION_CACHE_KEY_PRECISION)},${lng.toFixed(LOCATION_CACHE_KEY_PRECISION)}`;
        }
        
        // Process location name queue with rate limiting (1 request per second)
        async function processLocationQueue() {
            if (isProcessingLocationQueue || locationNameQueue.length === 0) {
                return;
            }
            
            isProcessingLocationQueue = true;
            
            while (locationNameQueue.length > 0) {
                const { lat, lng, resolve, reject } = locationNameQueue.shift();
                const cacheKey = getLocationCacheKey(lat, lng);
                
                // Check cache first
                if (locationNameCache.has(cacheKey)) {
                    resolve(locationNameCache.get(cacheKey));
                    continue;
                }
                
                try {
                    // Use OpenStreetMap Nominatim API for reverse geocoding
                    // Nominatim requires max 1 request per second
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
                    headers: {
                            'User-Agent': 'UMAK-Emergency-Alert-System/1.0',
                            'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                        throw new Error(`Geocoding failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                    let locationName = null;
                if (data && data.address) {
                    const addr = data.address;
                    // Build a readable address from available components
                        let name = '';
                    
                    // Try to get the most specific location name
                    if (addr.road || addr.street) {
                            name = (addr.road || addr.street);
                        if (addr.house_number) {
                                name = addr.house_number + ' ' + name;
                        }
                        if (addr.suburb || addr.neighbourhood) {
                                name += ', ' + (addr.suburb || addr.neighbourhood);
                        }
                    } else if (addr.suburb || addr.neighbourhood) {
                            name = addr.suburb || addr.neighbourhood;
                    } else if (addr.city || addr.town || addr.village) {
                            name = addr.city || addr.town || addr.village;
                    } else if (addr.municipality) {
                            name = addr.municipality;
                    }
                    
                    // Add city/municipality if not already included
                        if (name && (addr.city || addr.municipality) && !name.includes(addr.city || addr.municipality)) {
                            name += ', ' + (addr.city || addr.municipality);
                        }
                        
                        locationName = name || data.display_name || null;
                    } else {
                        locationName = data?.display_name || null;
                    }
                    
                    // Cache the result (even if null, to avoid repeated failed requests)
                    locationNameCache.set(cacheKey, locationName);
                    resolve(locationName);
                    
                    // Wait 1.1 seconds before next request (Nominatim rate limit: 1 req/sec)
                    if (locationNameQueue.length > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1100));
                    }
            } catch (error) {
                    // Cache null result to avoid repeated failures
                    locationNameCache.set(cacheKey, null);
                    resolve(null); // Resolve with null instead of rejecting to prevent UI blocking
                }
            }
            
            isProcessingLocationQueue = false;
        }
        
        // Reverse geocoding function to get location name from coordinates (rate-limited)
        async function getLocationName(lat, lng) {
            const cacheKey = getLocationCacheKey(lat, lng);
            
            // Check cache first
            if (locationNameCache.has(cacheKey)) {
                return locationNameCache.get(cacheKey);
            }
            
            // Add to queue
            return new Promise((resolve, reject) => {
                locationNameQueue.push({ lat, lng, resolve, reject });
                processLocationQueue();
            });
        }
        
        function refreshMap() {
            location.reload();
        }
        
        function toggleFullscreen() {
            const mapContainer = document.getElementById('map-container');
            if (!document.fullscreenElement) {
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen().then(() => {
                        setTimeout(() => map.invalidateSize(), 100);
                    });
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen().then(() => {
                        setTimeout(() => map.invalidateSize(), 100);
                    });
                }
            }
        }
        
        // Alert details modal functionality
        async function showAlertDetails(alertId, userId) {
            currentIncidentId = alertId;
            persistAlertModalState(alertId, userId);
            
            try {
                let studentDetails = null;
                if (userId) {
                    try {
                        const studentResponse = await fetch(`/api/student/${userId}`);
                        if (studentResponse.ok) {
                            const studentJson = await studentResponse.json();
                            studentDetails = studentJson.student || null;
                        }
                    } catch (studentError) {
                        console.warn('Unable to load student details:', studentError);
                    }
                }
                
                const incidentResponse = await fetch(`/api/incidents/${alertId}`);
                
                if (incidentResponse.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                
                if (incidentResponse.status === 403) {
                    const errData = await incidentResponse.json().catch(() => ({}));
                    alert(errData.error || errData.message || 'This alert is assigned to another responder.');
                    removeAlertCard(alertId);
                    clearAlertModalState();
                    closeAlertModal();
                    return;
                }
                
                if (!incidentResponse.ok) {
                    throw new Error('Failed to load incident details');
                }
                
                const incidentData = await incidentResponse.json();
                displayAlertDetails(alertId, incidentData.incident, studentDetails);
                updateAssignmentIndicator(incidentData.incident);
                updateActionButtons(incidentData.incident);
            } catch (error) {
                console.error('Error fetching alert details:', error);
                const incident = locations.find(loc => String(loc.icd_id) === String(alertId));
                if (incident) {
                    displayBasicAlertDetails(alertId, incident, null);
                } else {
                    alert('Unable to display alert details at this time.');
                }
            }
        }

        function removeAlertCard(alertId) {
            const card = document.querySelector(`.emergency-card[data-alert-id="${alertId}"]`);
            if (card && card.parentNode) {
                card.parentNode.removeChild(card);
            }
        }
        
        async function displayAlertDetails(alertId, incident, studentData) {
            let distanceInfo = '';
            let validLat = null;
            let validLng = null;
            let locationName = null;
            
            // Debug: Log incident data to check for location fields
            if (incident) {
                console.log('Incident location fields:', {
                    building: incident.icd_location_building,
                    floor: incident.icd_location_floor,
                    room: incident.icd_location_room,
                    hasBuilding: !!(incident.icd_location_building && String(incident.icd_location_building).trim()),
                    hasFloor: !!(incident.icd_location_floor && String(incident.icd_location_floor).trim()),
                    hasRoom: !!(incident.icd_location_room && String(incident.icd_location_room).trim())
                });
            }
            
            if (incident) {
                // Validate coordinates before calculating distance
                let lat = parseFloat(incident.icd_lat);
                let lng = parseFloat(incident.icd_lng);
                
                if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    validLat = lat;
                    validLng = lng;
                    const distance = calculateDistance(UMAK_LAT, UMAK_LNG, lat, lng);
                    distanceInfo = formatDistance(distance);
                    
                    // Get location name from coordinates
                    locationName = await getLocationName(lat, lng);
                } else {
                    distanceInfo = 'Location unavailable';
                }
            }

            // Determine icd_type based on category and specific type
            let icdType = 'General Emergency';
            if (incident && incident.icd_category) {
                switch(incident.icd_category) {
                    case 'Medical':
                        icdType = incident.icd_medical_type || 'Medical Emergency';
                        break;
                    case 'Security':
                        icdType = incident.icd_security_type || 'Security Emergency';
                        break;
                    case 'University':
                        icdType = incident.icd_university_type || 'University Emergency';
                        break;
                    case 'Urgent':
                        icdType = 'Urgent Emergency';
                        break;
                    default:
                        icdType = incident.icd_category + ' Emergency';
                }
            }

            // Helper functions for styling with updated colors
            function getCategoryBgColor(category) {
                switch(category) {
                    case 'Urgent': return 'bg-red-900';
                    case 'Medical': return 'bg-red-600';
                    case 'Security': return 'bg-blue-900';
                    case 'University': return 'bg-yellow-500';
                    default: return 'bg-gray-500';
                }
            }

            function getCategoryBorderColor(category) {
                switch(category) {
                    case 'Urgent': return 'border-red-900';
                    case 'Medical': return 'border-red-600';
                    case 'Security': return 'border-blue-900';
                    case 'University': return 'border-yellow-500';
                    default: return 'border-gray-500';
                }
            }
            
            // Hex colors for category-specific outlines (used for header section outline)
            function getCategoryHexBorderColor(category) {
                switch(category) {
                    case 'Urgent': return '#7c2d12';     // red-900
                    case 'Medical': return '#dc2626';    // red-600
                    case 'Security': return '#1e3a8a';   // blue-900
                    case 'University': return '#eab308'; // yellow-500
                    default: return '#6b7280';           // gray-500
                }
            }
            
            // Format timestamp to readable string
            function formatTimelineTimestamp(ts) {
                if (!ts) return '—';
                try {
                    const d = new Date(ts);
                    if (isNaN(d.getTime())) return '—';
                    // Convert to Philippines timezone (Asia/Manila, UTC+8)
                    return d.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: '2-digit',
                        timeZone: 'Asia/Manila'
                    }) + ' ' + d.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true,
                        timeZone: 'Asia/Manila'
                    });
                } catch {
                    return '—';
                }
            }
            
            // Build professional timeline based on incident (status + timestamps)
            function buildTimelineFromIncident(incident) {
                const status = incident ? incident.icd_status : 'Unknown';
                const reportedTs = incident ? incident.icd_timestamp : null;
                const pendingTs = incident && (incident.pending_timestamp || incident.acknowledged_timestamp) ? (incident.pending_timestamp || incident.acknowledged_timestamp) : null;
                const resolvedTs = incident ? incident.resolved_timestamp : null;
                const cancelledTs = incident ? incident.cancelled_timestamp : null;
                
                // Determine which steps are active based on mapping:
                // Reported (active - Active/Pending/Resolved/Cancelled)
                const isReportedActive = ['Active','Pending','Resolved','Cancelled'].includes(status);
                // Acknowledged (pending)
                const isAcknowledgedActive = ['Pending','Resolved','Cancelled'].includes(status);
                // In Progress (still pending)
                const isInProgressActive = ['Pending','Resolved'].includes(status);
                // Resolved (resolved)
                const isResolvedActive = status === 'Resolved';
                // Cancelled (only show if cancelled)
                const showCancelled = status === 'Cancelled' || !!cancelledTs;
                const isCancelledActive = status === 'Cancelled';
                
                const items = [
                    {
                        label: 'Reported',
                        active: isReportedActive,
                        ts: formatTimelineTimestamp(reportedTs),
                    },
                    {
                        label: 'Acknowledged',
                        active: isAcknowledgedActive,
                        ts: formatTimelineTimestamp(pendingTs),
                    },
                    {
                        label: 'In Progress',
                        active: isInProgressActive,
                        ts: formatTimelineTimestamp(pendingTs),
                    },
                    {
                        label: 'Resolved',
                        active: isResolvedActive,
                        ts: formatTimelineTimestamp(resolvedTs),
                    },
                ];
                
                if (showCancelled) {
                    items.push({
                        label: 'Cancelled',
                        active: isCancelledActive,
                        ts: formatTimelineTimestamp(cancelledTs),
                    });
                }
                
                const htmlItems = items.map(it => `
                    <div class="timeline-item ${it.active ? 'active' : ''}">
                        <span class="timeline-dot"></span>
                        <div class="timeline-content">
                            <span class="timeline-label">${it.label}</span>
                            <span class="timeline-timestamp ${it.active ? 'text-gray-600' : 'text-gray-400'}">${it.ts}</span>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div class="timeline bg-white rounded-lg p-4 section-emphasis">
                        ${htmlItems}
                    </div>
                `;
            }

            // Build student information HTML
            let personalDetailsHTML = '';
            let emergencyContactsHTML = '';
            
            if (studentData && !studentData.error) {
                personalDetailsHTML = `
                    <div class="info-section">
                        <h4>
                            <i class="fas fa-user text-blue-600"></i>
                            Personal Details
                        </h4>
                        <div class="detail-row">
                            <span class="detail-label">Student ID:</span>
                            <span class="detail-value">${studentData.student_id || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Full Name:</span>
                            <span class="detail-value">${studentData.full_name || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${studentData.student_email || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Year Level:</span>
                            <span class="detail-value">${studentData.student_yearlvl || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">College:</span>
                            <span class="detail-value">${studentData.student_college || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Contact Number:</span>
                            <span class="detail-value">${studentData.student_cnum || 'N/A'}</span>
                        </div>
                    </div>
                `;

                emergencyContactsHTML = `
                    <div class="info-section">
                        <h4>
                            <i class="fas fa-phone text-orange-600"></i>
                            Emergency Contacts
                        </h4>
                        <div class="detail-row">
                            <span class="detail-label">Primary Contact:</span>
                            <span class="detail-value">${studentData.primary_emergencycontact || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Primary Contact Person:</span>
                            <span class="detail-value">${studentData.primary_contactperson || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Primary Relationship:</span>
                            <span class="detail-value">${studentData.primary_cprelationship || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Secondary Contact:</span>
                            <span class="detail-value">${studentData.secondary_emergencycontact || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Secondary Contact Person:</span>
                            <span class="detail-value">${studentData.secondary_contactperson || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Secondary Relationship:</span>
                            <span class="detail-value">${studentData.secondary_cprelationship || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } else {
                personalDetailsHTML = `
                    <div class="info-section">
                        <h4>
                            <i class="fas fa-user text-blue-600"></i>
                            Personal Details
                        </h4>
                        <p class="text-gray-500 text-center py-4">Student information not available</p>
                    </div>
                `;
                emergencyContactsHTML = `
                    <div class="info-section">
                        <h4>
                            <i class="fas fa-phone text-orange-600"></i>
                            Emergency Contacts
                        </h4>
                        <p class="text-gray-500 text-center py-4">Emergency contacts not available</p>
                    </div>
                `;
            }

            // Build the complete modal HTML
            const detailsHTML = `
                <!-- Header Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6" style="box-shadow: inset 0 0 0 2px ${getCategoryHexBorderColor(incident ? incident.icd_category : 'Unknown')}; border-radius: 0.5rem;">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium text-white ${getCategoryBgColor(incident ? incident.icd_category : 'Unknown')}">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    ${incident ? incident.icd_category : 'Unknown'} Alert
                                </span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${icdType}</h3>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                <span class="inline-flex items-center px-2 py-1 rounded text-orange-700 bg-orange-100">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${incident ? incident.icd_status : 'Unknown'}
                                </span>
                                <span>${incident ? new Date(incident.icd_timestamp).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    timeZone: 'Asia/Manila'
                                }) + ' at ' + new Date(incident.icd_timestamp).toLocaleTimeString('en-US', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: true,
                                    timeZone: 'Asia/Manila'
                                }) : new Date().toLocaleString('en-US', { timeZone: 'Asia/Manila' })}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600 mb-1">Incident ID</div>
                            <div class="text-2xl font-bold text-gray-900">#${typeof alertId === 'string' ? alertId.replace('ICD', '') : alertId}</div>
                        </div>
                    </div>
                </div>

                <!-- Main Content - Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Left Column: Incident Information -->
                    <div class="bg-white rounded-lg p-4 section-emphasis">
                        <h4 class="flex items-center text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                            Incident Information
                        </h4>
                        
                        <div class="space-y-3">
                            <div class="detail-row">
                                <span class="detail-label">Category:</span>
                                <span class="inline-flex items-center px-2 py-1 rounded text-sm font-medium text-white ${getCategoryBgColor(incident ? incident.icd_category : 'Unknown')}">
                                    ${incident ? incident.icd_category : 'Unknown'}
                                </span>
                            </div>
                            
                            <div class="detail-row">
                                <span class="detail-label">Type:</span>
                                <span class="detail-value font-medium">${icdType}</span>
                            </div>
                            
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="inline-flex items-center px-2 py-1 rounded text-sm font-medium text-orange-600 bg-orange-100">
                                    ${incident ? incident.icd_status : 'Unknown'}
                                </span>
                            </div>
                            
                            <div class="detail-row">
                                <span class="detail-label">Reported:</span>
                                <span class="detail-value">${incident ? new Date(incident.icd_timestamp).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    timeZone: 'Asia/Manila'
                                }) + ' at ' + new Date(incident.icd_timestamp).toLocaleTimeString('en-US', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: true,
                                    timeZone: 'Asia/Manila'
                                }) : new Date().toLocaleString('en-US', { timeZone: 'Asia/Manila' })}</span>
                            </div>
                            
                            <div class="detail-row">
                                <span class="detail-label">Location:</span>
                                <span class="detail-value">
                                    ${locationName ? `<div class="font-semibold text-blue-600 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${locationName}</div>` : ''}
                                    ${validLat !== null && validLng !== null ? validLat.toFixed(6) + ', ' + validLng.toFixed(6) : (incident ? 'Invalid coordinates' : 'N/A')}<br>
                                    <span class="text-sm text-gray-500">${distanceInfo} from UMAK</span>
                                </span>
                            </div>
                            
                            ${incident && incident.icd_location_building && String(incident.icd_location_building).trim() ? `
                            <div class="detail-row">
                                <span class="detail-label">Building:</span>
                                <span class="detail-value">${escapeHtml(String(incident.icd_location_building).trim())}</span>
                            </div>
                            ` : ''}
                            
                            ${incident && incident.icd_location_floor && String(incident.icd_location_floor).trim() ? `
                            <div class="detail-row">
                                <span class="detail-label">Floor:</span>
                                <span class="detail-value">${escapeHtml(String(incident.icd_location_floor).trim())}</span>
                            </div>
                            ` : ''}
                            
                            ${incident && incident.icd_location_room && String(incident.icd_location_room).trim() ? `
                            <div class="detail-row">
                                <span class="detail-label">Room:</span>
                                <span class="detail-value">${escapeHtml(String(incident.icd_location_room).trim())}</span>
                            </div>
                            ` : ''}
                            
                            <div class="detail-row border-t border-gray-100">
                                <span class="detail-label">User ID:</span>
                                <span class="detail-value font-medium">${incident ? incident.user_id : 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Description -->
                    <div class="bg-white rounded-lg p-4 section-emphasis">
                        <h4 class="flex items-center text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-file-alt text-green-500 mr-2"></i>
                            Description
                        </h4>
                        
                        <div class="text-gray-700 leading-relaxed">
                            ${incident && incident.icd_description ? incident.icd_description : 'No description available'}
                        </div>
                    </div>
                </div>

                <!-- Student Information Section (Collapsible) -->
                <div class="bg-gray-50 rounded-lg section-emphasis">
                    <div class="p-4 cursor-pointer" onclick="toggleStudentInfo()">
                        <h4 class="flex items-center justify-between text-lg font-semibold text-gray-900">
                            <span>
                                <i class="fas fa-user text-blue-500 mr-2"></i>
                                Student Information
                            </span>
                            <i class="fas fa-chevron-down text-gray-400" id="studentInfoChevron"></i>
                        </h4>
                    </div>
                    
                    <div id="studentInfoContent" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-4">
                            ${personalDetailsHTML}
                            ${emergencyContactsHTML}
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="p-4 border-t border-gray-200">
                            <h5 class="text-md font-semibold text-gray-800 mb-3">Additional Information</h5>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="detail-row">
                                    <span class="detail-label">Address:</span>
                                    <span class="detail-value">${studentData && studentData.student_address ? studentData.student_address : 'N/A'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Medical Info:</span>
                                    <span class="detail-value">${studentData && studentData.student_medinfo ? studentData.student_medinfo : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Track Status toggle and timeline -->
                <div class="mt-6 border border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm">
                    <button type="button" onclick="toggleTimeline()" class="w-full flex items-center justify-between px-5 py-3 bg-slate-700 hover:bg-slate-800 text-white transition">
                        <span class="text-sm font-semibold tracking-wide uppercase">Track Status</span>
                        <span class="flex items-center gap-2 text-xs font-medium">
                            <span id="timelineStatusLabel">Hide</span>
                            <i id="timelineChevron" class="fas fa-chevron-up transition-transform duration-200 ease-out"></i>
                        </span>
                    </button>
                    <div id="timelineSection" class="timeline-collapse open px-5 py-4 bg-white" aria-hidden="false">
                        ${buildTimelineFromIncident(incident)}
                    </div>
                </div>
            `;
            
            currentIncidentContext = {
                incidentId: alertId,
                incident: incident,
                studentData: studentData,
                incidentLabel: formatIncidentDisplayId(incident ? incident.icd_id : alertId)
            };

            document.getElementById('alertDetails').innerHTML = detailsHTML;
            initializeTimelineSection();
            document.getElementById('incidentIdInput').value = alertId;
            document.getElementById('pendingIncidentIdInput').value = alertId;
            document.getElementById('cancelledIncidentIdInput').value = alertId;
            document.getElementById('dispatchIncidentIdInput').value = alertId;
            
            // Setup modal map
            setupModalMap(incident);
            
            // Set modal border color based on category
            const modalContent = document.querySelector('.modal-content');
            const categoryBorderColor = getCategoryBorderColor(incident ? incident.icd_category : 'Unknown');
            modalContent.className = `modal-content max-w-screen-2xl w-full ${categoryBorderColor}`;
            
            document.getElementById('alertModal').classList.add('show');
            updateAssignmentIndicator(incident);
            updateActionButtons(incident);
            
            // Check permissions and update UI (including chat button state)
            setTimeout(() => {
                checkIncidentPermissionsAndUpdateUI(alertId, incident);
                updateActionButtons(incident);
            }, 100);
            
            setTimeout(() => {
                if (modalMap) {
                    modalMap.invalidateSize();
                }
            }, 100);
        }
        
        function updateAssignmentIndicator(incident) {
            const alertDetails = document.getElementById('alertDetails');
            if (!alertDetails) return;
            
            let indicator = document.getElementById('assignmentDisplay');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'assignmentDisplay';
                indicator.className = 'mb-4';
                alertDetails.prepend(indicator);
            }
            
            const assignmentInfo = document.getElementById('assignmentInfo');
            const assignedId = incident && incident.assigned_responder_id !== undefined && incident.assigned_responder_id !== null
                ? String(incident.assigned_responder_id)
                : '';
            const assignedName = incident && incident.assigned_responder_name ? incident.assigned_responder_name : '';
            const status = (incident && incident.icd_status) || 'Unknown';
            const isAssignedToMe = assignedId && assignedId === LOGGED_IN_ADMIN_ID;
            
            if (assignedId) {
                if (isAssignedToMe) {
                    indicator.className = 'mb-4 p-3 rounded-lg border border-green-500 bg-green-50 text-green-800 text-sm font-semibold';
                    indicator.innerHTML = `<i class="fas fa-user-check mr-2"></i> Pending • ${escapeHtml(assignedName || 'You')} (You)`;
                } else {
                    indicator.className = 'mb-4 p-3 rounded-lg border border-yellow-500 bg-yellow-50 text-yellow-800 text-sm font-semibold';
                    indicator.innerHTML = `<i class="fas fa-user-lock mr-2"></i> Pending • ${escapeHtml(assignedName || 'Assigned Responder')}`;
                }
            } else if (status === 'Active') {
                indicator.className = 'mb-4 p-3 rounded-lg border border-blue-500 bg-blue-50 text-blue-800 text-sm font-semibold';
                indicator.innerHTML = `<i class="fas fa-user-plus mr-2"></i> Pending • Unassigned`;
            } else {
                indicator.className = '';
                indicator.innerHTML = '';
            }
            
            if (assignmentInfo) {
                if (assignedId) {
                    assignmentInfo.className = 'mb-4 p-3 rounded-lg border border-blue-200 bg-blue-50 text-sm text-blue-800';
                    assignmentInfo.innerHTML = `<i class="fas fa-user-shield mr-2"></i> Assigned to <strong>${escapeHtml(assignedName || assignedId)}</strong>`;
                } else {
                    assignmentInfo.className = 'mb-4 p-3 rounded-lg border border-gray-200 bg-gray-50 text-sm text-gray-700';
                    assignmentInfo.innerHTML = `<i class="fas fa-user-plus mr-2"></i> This alert is not assigned. Submitting will mark it as Pending.`;
                }
            }
        }
        
        function updateActionButtons(incident) {
            const pendingBtn = document.getElementById('pendingBtn');
            const cancelledBtn = document.getElementById('cancelledBtn');
            const resolveBtn = document.getElementById('resolveBtn');
            const chatBtn = document.getElementById('chatBtn');
            const status = (incident && incident.icd_status) || 'Unknown';
            const assignedId = incident && incident.assigned_responder_id !== undefined && incident.assigned_responder_id !== null
                ? String(incident.assigned_responder_id)
                : '';
            const assignedName = incident && incident.assigned_responder_name ? incident.assigned_responder_name : '';
            const isAssignedToMe = assignedId && assignedId === LOGGED_IN_ADMIN_ID;
            const isUnassigned = !assignedId;
            const isResolvedOrCancelled = status === 'Resolved' || status === 'Cancelled';
            const canEdit = !isResolvedOrCancelled && (isUnassigned || isAssignedToMe);
            
            if (pendingBtn) {
                if (status === 'Active') {
                    pendingBtn.classList.remove('hidden');
                    const label = pendingBtn.querySelector('.button-label');
                    if (label) {
                        if (assignedId) {
                            label.textContent = assignedName ? `Pending • ${assignedName}` : 'Pending';
                        } else {
                            label.textContent = 'Pending (Assign to me)';
                        }
                    }
                    pendingBtn.disabled = !(isUnassigned || isAssignedToMe);
                    pendingBtn.title = pendingBtn.disabled ? 'Only the assigned responder may mark as Pending' : 'Mark incident as Pending';
                    toggleButtonState(pendingBtn, !pendingBtn.disabled);
                } else {
                    pendingBtn.classList.add('hidden');
                }
            }
            
            if (cancelledBtn) {
                if (status === 'Active' || status === 'Pending') {
                    cancelledBtn.classList.remove('hidden');
                    cancelledBtn.disabled = !canEdit;
                    cancelledBtn.title = cancelledBtn.disabled ? 'Only the assigned responder may cancel this incident' : 'Mark incident as Cancelled';
                    toggleButtonState(cancelledBtn, !cancelledBtn.disabled);
                } else {
                    cancelledBtn.classList.add('hidden');
                }
            }
            
            if (resolveBtn) {
                if (status === 'Pending') {
                    resolveBtn.classList.remove('hidden');
                    resolveBtn.disabled = !isAssignedToMe;
                    resolveBtn.title = resolveBtn.disabled ? 'Only the assigned responder may resolve this incident' : 'Mark incident as Resolved';
                    toggleButtonState(resolveBtn, !resolveBtn.disabled);
                } else {
                    resolveBtn.classList.add('hidden');
                }
            }
            
            if (chatBtn) {
                const canChat = !isResolvedOrCancelled && isAssignedToMe && incident && incident.user_id;

                if (canChat) {
                    let studentName = incident.student_full_name || incident.student_name || incident.full_name || 'Student';
                    try {
                        const match = locations && Array.isArray(locations) ? locations.find(loc => String(loc.icd_id) === String(incident.icd_id)) : null;
                        if (match) {
                            studentName = match.student_full_name || match.student_name || match.full_name || studentName;
                        }
                    } catch (e) {}

                    const incidentIdForChat = incident.icd_id;
                    chatBtn.disabled = false;
                    chatBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    chatBtn.classList.remove('hidden');
                    chatBtn.title = 'Chat with the student for this assigned incident';
                    chatBtn.onclick = function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Alert Details chat button clicked (assigned responder):', {
                            userId: incident.user_id,
                            studentName,
                            incidentId: incidentIdForChat
                        });
                        startChatWithStudent(incident.user_id, studentName, incidentIdForChat);
                    };
                } else {
                    // Hide or disable chat for non-assigned admins or resolved/cancelled incidents
                    chatBtn.disabled = true;
                    chatBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    chatBtn.title = isAssignedToMe
                        ? 'Chat is disabled for resolved or cancelled incidents.'
                        : 'You must be the assigned responder to use chat for this incident.';
                    chatBtn.onclick = null;
                }
            }
        }
        
        function toggleButtonState(button, isEnabled) {
            if (!button) return;
            if (!isEnabled) {
                button.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // Fallback function for basic alert details display
        async function displayBasicAlertDetails(alertId, incident, studentData) {
            let distanceInfo = '';
            let locationName = null;
            
            if (incident) {
                // Validate coordinates before calculating distance
                let lat = parseFloat(incident.icd_lat);
                let lng = parseFloat(incident.icd_lng);
                
                if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    const distance = calculateDistance(UMAK_LAT, UMAK_LNG, lat, lng);
                    distanceInfo = formatDistance(distance);
                    
                    // Get location name from coordinates
                    locationName = await getLocationName(lat, lng);
                } else {
                    distanceInfo = 'Location unavailable';
                }
            }

            // Determine icd_type based on category
            let icdType = 'General Emergency';
            if (incident && incident.icd_category) {
                icdType = incident.icd_category + ' Emergency';
            }

            const buildingInfo = incident && incident.icd_location_building && incident.icd_location_building.trim() ? `<p class="text-gray-500 text-sm mt-1"><strong>Building:</strong> ${escapeHtml(incident.icd_location_building)}</p>` : '';
            const floorInfo = incident && incident.icd_location_floor && incident.icd_location_floor.trim() ? `<p class="text-gray-500 text-sm mt-1"><strong>Floor:</strong> ${escapeHtml(incident.icd_location_floor)}</p>` : '';
            const roomInfo = incident && incident.icd_location_room && incident.icd_location_room.trim() ? `<p class="text-gray-500 text-sm mt-1"><strong>Room:</strong> ${escapeHtml(incident.icd_location_room)}</p>` : '';
            const locationDisplay = locationName ? 
                `<p class="text-gray-600"><strong>📍 Location:</strong> <span class="text-blue-600 font-semibold">${locationName}</span></p>
                 <p class="text-gray-500 text-sm">Coordinates: ${incident ? incident.icd_lat + ', ' + incident.icd_lng : 'N/A'}</p>
                 ${buildingInfo}${floorInfo}${roomInfo}` :
                `<p class="text-gray-600"><strong>🌍 Coordinates:</strong> ${incident ? incident.icd_lat + ', ' + incident.icd_lng : 'N/A'}</p>
                 ${buildingInfo}${floorInfo}${roomInfo}`;
            
            const detailsHTML = `
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${icdType}</h3>
                    <p class="text-gray-600">INCIDENT ID: ICD_${typeof alertId === 'string' ? alertId.replace('ICD', '') : alertId}</p>
                    <p class="text-gray-600">Status: ${incident ? incident.icd_status : 'Unknown'}</p>
                    ${locationDisplay}
                    <p class="text-gray-600">Distance: ${distanceInfo} from UMAK</p>
                </div>
            `;
            
            document.getElementById('alertDetails').innerHTML = detailsHTML;
            initializeTimelineSection();
            document.getElementById('incidentIdInput').value = alertId;
            document.getElementById('pendingIncidentIdInput').value = alertId;
            document.getElementById('cancelledIncidentIdInput').value = alertId;
            document.getElementById('dispatchIncidentIdInput').value = alertId;
            
            currentIncidentContext = {
                incidentId: alertId,
                incident: incident,
                studentData: studentData,
                incidentLabel: formatIncidentDisplayId(incident ? incident.icd_id : alertId)
            };

            setupModalMap(incident);
            
            // Set modal border color based on category
            const modalContent = document.querySelector('.modal-content');
            const categoryBorderColor = getCategoryBorderColor(incident ? incident.icd_category : 'Unknown');
            modalContent.className = `modal-content max-w-screen-2xl w-full ${categoryBorderColor}`;
            
            document.getElementById('alertModal').classList.add('show');
        }
        
        // Toggle function for student information section
        function toggleStudentInfo() {
            const content = document.getElementById('studentInfoContent');
            const chevron = document.getElementById('studentInfoChevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        }
        
        // Toggle function for timeline section
        function toggleTimeline(forceState) {
            const timeline = document.getElementById('timelineSection');
            const chevron = document.getElementById('timelineChevron');
            const statusLabel = document.getElementById('timelineStatusLabel');
            
            if (!timeline) {
                return;
            }
            
            const shouldOpen = typeof forceState === 'boolean' ? forceState : !timeline.classList.contains('open');
            
            if (shouldOpen) {
                timeline.classList.add('open');
                timeline.style.maxHeight = timeline.scrollHeight + 'px';
                timeline.setAttribute('aria-hidden', 'false');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                }
                if (statusLabel) {
                    statusLabel.textContent = 'Hide';
                }
            } else {
                timeline.classList.remove('open');
                timeline.style.maxHeight = null;
                timeline.setAttribute('aria-hidden', 'true');
                if (chevron) {
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
                if (statusLabel) {
                    statusLabel.textContent = 'Show';
                }
            }
        }
        
        function initializeTimelineSection() {
            const timeline = document.getElementById('timelineSection');
            if (timeline) {
                // Set initial max-height if already open
                if (timeline.classList.contains('open')) {
                    requestAnimationFrame(() => {
                        timeline.style.maxHeight = timeline.scrollHeight + 'px';
                        // Recompute after any layout changes
                        setTimeout(() => {
                            if (timeline.classList.contains('open')) {
                                timeline.style.maxHeight = timeline.scrollHeight + 'px';
                            }
                        }, 150);
                    });
                } else {
                    // Force open state on initial render
                    requestAnimationFrame(() => {
                        toggleTimeline(true);
                        setTimeout(() => {
                            if (timeline.classList.contains('open')) {
                                timeline.style.maxHeight = timeline.scrollHeight + 'px';
                            }
                        }, 150);
                    });
                }
            }
        }
        
        // Setup modal map
        async function setupModalMap(incident) {
            if (!modalMap) {
                modalMap = L.map('modalMap').setView([14.5633428, 121.0565387], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(modalMap);
                
                // Add UMAK circle to modal map as well
                L.circle([UMAK_LAT, UMAK_LNG], {
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.2,
                    radius: 500,
                    weight: 2
                }).addTo(modalMap).bindPopup("<b>UMAK Campus Radius</b><br>500 meter coverage area");
            }
            
            const recenterBtn = document.getElementById('modalMapRecenter');
            
            if (incident) {
                modalMarkers.forEach(marker => modalMap.removeLayer(marker));
                modalMarkers = [];
                
                // Validate coordinates
                let lat = parseFloat(incident.icd_lat);
                let lng = parseFloat(incident.icd_lng);
                
                // Check if coordinates are valid numbers and within reasonable bounds
                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    lat = UMAK_LAT;
                    lng = UMAK_LNG;
                }
                
                const markerColor = incident.icd_status === 'Active' ? 'red' : 
                                  incident.icd_status === 'Pending' ? 'orange' : 
                                  incident.icd_status === 'Resolved' ? 'green' : 'grey';
                
                const markerIcon = L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${markerColor}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                
                const marker = L.marker([lat, lng], {icon: markerIcon}).addTo(modalMap);
                
                // Add flashing animation to Active markers in modal too
                if (incident.icd_status === 'Active') {
                    setTimeout(() => {
                        const markerElement = marker.getElement();
                        if (markerElement) {
                            markerElement.classList.add('active-marker-flash');
                        }
                    }, 100);
                }
                
                // Find student name from incident data
                // Get full_name from accounts_student table (via student_full_name field)
                const studentModal = locations.find(loc => String(loc.icd_id) === String(incident.icd_id));
                const studentNameModal = studentModal && studentModal.student_full_name ? 
                                        studentModal.student_full_name : 
                                        (studentModal && (studentModal.student_name || studentModal.full_name) ? 
                                         (studentModal.student_name || studentModal.full_name) : 'Unknown Student');
                const incidentIdModal = incident.icd_id !== undefined && incident.icd_id !== null ? String(incident.icd_id) : '';
                const safeIncidentIdModal = incidentIdModal.replace(/"/g, '\\"');
                
                // Extract numeric part from ICD ID for display
                const displayId = typeof incident.icd_id === 'string' ? 
                                 incident.icd_id.replace('ICD', '') : incident.icd_id;
                
                // Get location name for modal popup
                const modalLocationName = await getLocationName(lat, lng);
                const modalLocationDisplay = modalLocationName ? 
                    "<div style='padding: 6px 0; margin: 4px 0; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;'>" +
                    "<div style='padding: 2px 0;'><b>📍 Location Name:</b></div>" +
                    "<div style='padding: 2px 0; color: #3b82f6; font-weight: 600; font-size: 13px;'>" + modalLocationName + "</div>" +
                    "<div style='padding: 2px 0; font-size: 10px; color: #6b7280; margin-top: 2px;'>Coordinates: " + lat.toFixed(6) + ", " + lng.toFixed(6) + "</div>" +
                    "</div>" :
                    "<div style='padding: 4px 0; margin: 4px 0; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;'>" +
                    "<div style='padding: 2px 0;'><b>🌍 Coordinates:</b></div>" +
                    "<div style='padding: 2px 0; font-size: 12px; color: #6b7280;'>" + lat.toFixed(6) + ", " + lng.toFixed(6) + "</div>" +
                    "</div>";
                
            // Calculate distance for modal popup
            const modalDistance = calculateDistance(UMAK_LAT, UMAK_LNG, lat, lng);
            const modalDistanceText = formatDistance(modalDistance);
            
            marker.bindPopup(
                "<div style='min-width: 280px; font-family: Inter, sans-serif;'>" +
                "<div style='background: linear-gradient(135deg, " + (incident.icd_status === 'Active' ? '#ef4444' : incident.icd_status === 'Pending' ? '#f59e0b' : incident.icd_status === 'Resolved' ? '#10b981' : '#6b7280') + ", " + (incident.icd_status === 'Active' ? '#dc2626' : incident.icd_status === 'Pending' ? '#d97706' : incident.icd_status === 'Resolved' ? '#059669' : '#4b5563') + "); color: white; padding: 8px 12px; margin: -12px -12px 8px -12px; border-radius: 12px 12px 0 0; font-weight: 600;'>" +
                "<b>📍 ICD_" + displayId + "</b> - " + incident.icd_status + " " + (incident.icd_category === 'Urgent' ? '🚨' : incident.icd_category === 'Medical' ? '🏥' : incident.icd_category === 'Security' ? '🛡️' : incident.icd_category === 'University' ? '🏫' : '⚠️') +
                "</div>" +
                "<div style='padding: 4px 0;'><b>👤 Student:</b> " + studentNameModal + "</div>" +
                "<div style='padding: 4px 0;'><b>📊 Status:</b> <span style='color: " + (incident.icd_status === 'Active' ? '#ef4444' : incident.icd_status === 'Pending' ? '#f59e0b' : incident.icd_status === 'Resolved' ? '#10b981' : '#6b7280') + "; font-weight: 600;'>" + incident.icd_status + "</span></div>" +
                "<div style='padding: 4px 0;'><b>🏷️ Category:</b> " + (incident.icd_category || 'Unknown') + "</div>" +
                modalLocationDisplay +
                "<div style='padding: 4px 0;'><b>📏 Distance:</b> " + modalDistanceText + " from UMAK</div>" +
                "<div style='padding: 4px 0;'><b>🕒 Time:</b> " + new Date(incident.icd_timestamp).toLocaleString('en-US', { timeZone: 'Asia/Manila' }) + "</div>" +
                (incident.icd_description ? "<div style='padding: 4px 0;'><b>📝 Description:</b> " + incident.icd_description.substring(0, 80) + (incident.icd_description.length > 80 ? '...' : '') + "</div>" : '') +
                "<div style='margin-top: 8px; display: flex; gap: 4px;'>" +
                "<button onclick='startChatWithStudent(\"" + incident.user_id + "\", \"" + studentNameModal.replace(/"/g, '\\"') + "\", \"" + safeIncidentIdModal + "\"); if (typeof modalMap !== \"undefined\" && modalMap) { modalMap.closePopup(); }' style='flex: 1; background: #10b981; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.2s;'>💬 Chat</button>" +
                "</div>" +
                "</div>"
            );
                modalMarkers.push(marker);
                
                modalMapTargetLatLng = [lat, lng];
                modalMap.setView(modalMapTargetLatLng, 16);
                
                if (recenterBtn) {
                    recenterBtn.disabled = false;
                    recenterBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    recenterBtn.onclick = recenterModalMap;
                }
            } else {
                modalMapTargetLatLng = [UMAK_LAT, UMAK_LNG];
                modalMap.setView(modalMapTargetLatLng, 15);
                
                if (recenterBtn) {
                    recenterBtn.disabled = true;
                    recenterBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    recenterBtn.onclick = null;
                }
            }
        }
        
        function recenterModalMap() {
            if (!modalMap) {
                return;
            }
            
            const targetLatLng = modalMapTargetLatLng || [UMAK_LAT, UMAK_LNG];
            const targetZoom = modalMapTargetLatLng ? Math.max(modalMap.getZoom(), 16) : 15;
            
            modalMap.flyTo(targetLatLng, targetZoom, {
                animate: true,
                duration: 0.65
            });
        }

        // Action functions
        function markAsResolved() {
            if (currentIncidentId) {
                showResolvedConfirmModal();
            }
        }

        function showResolvedConfirmModal() {
            document.getElementById('resolvedConfirmModal').classList.add('show');
        }
        
        function closeResolvedConfirmModal() {
            document.getElementById('resolvedConfirmModal').classList.remove('show');
        }
        
        function confirmResolvedAction() {
            closeResolvedConfirmModal();
            openResolutionSummaryModal();
        }

        function openResolutionSummaryModal() {
            if (!currentIncidentContext || !currentIncidentContext.incidentId) {
                alert('Incident details are not available. Please reopen the alert and try again.');
                return;
            }

            const modal = document.getElementById('resolutionSummaryModal');
            if (!modal) {
                return;
            }

            const incident = currentIncidentContext.incident || {};
            const studentData = currentIncidentContext.studentData || {};
            const incidentId = currentIncidentContext.incidentId;
            const incidentLabel = currentIncidentContext.incidentLabel || formatIncidentDisplayId(incidentId);
            const now = new Date();
            const reportedAt = incident.icd_timestamp || incident.formatted_timestamp || null;
            const studentName = studentData.full_name || studentData.student_name || incident.student_name || 'N/A';
            const category = incident.icd_category || 'N/A';

            const incidentIdInput = document.getElementById('incidentIdInput');
            if (incidentIdInput) {
                incidentIdInput.value = incidentId;
            }

            const headline = document.getElementById('summaryModalHeadline');
            if (headline) {
                headline.textContent = incidentLabel;
            }

            const timestampLine = document.getElementById('summaryModalTimestamp');
            if (timestampLine) {
                timestampLine.textContent = `Resolved ${formatDateTime(now)} • ${LOGGED_IN_ADMIN_NAME}`;
            }

            const reportedField = document.getElementById('summaryModalReportedAt');
            if (reportedField) {
                reportedField.textContent = formatDateTime(reportedAt);
            }

            const resolvedField = document.getElementById('summaryModalResolvedAt');
            if (resolvedField) {
                resolvedField.textContent = formatDateTime(now);
            }

            const responseField = document.getElementById('summaryModalResponseTime');
            if (responseField) {
                responseField.textContent = formatResponseDuration(reportedAt, now);
            }

            const handledByField = document.getElementById('summaryModalHandledBy');
            if (handledByField) {
                handledByField.textContent = LOGGED_IN_ADMIN_NAME;
            }

            const studentField = document.getElementById('summaryModalStudent');
            if (studentField) {
                studentField.textContent = studentName || 'N/A';
            }

            const categoryField = document.getElementById('summaryModalCategory');
            if (categoryField) {
                categoryField.textContent = category || 'N/A';
            }

            const summaryInput = document.getElementById('resolutionSummaryInput');
            if (summaryInput) {
                summaryInput.value = '';
                updateResolutionSummaryCharCount();
            }

            const submitBtn = document.getElementById('resolutionSummarySubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit & Archive';
            }

            modal.classList.add('show');
            setTimeout(() => {
                if (summaryInput) {
                    summaryInput.focus();
                }
            }, 100);
        }

        function closeResolutionSummaryModal() {
            const modal = document.getElementById('resolutionSummaryModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function updateResolutionSummaryCharCount() {
            const input = document.getElementById('resolutionSummaryInput');
            const counter = document.getElementById('resolutionSummaryCharCount');
            if (!input || !counter) {
                return;
            }
            const length = input.value.trim().length;
            counter.textContent = `${length} character${length === 1 ? '' : 's'}`;
        }

        function markAsPending() {
            if (currentIncidentId) {
                showPendingConfirmModal();
            }
        }
        
        function showPendingConfirmModal() {
            document.getElementById('pendingConfirmModal').classList.add('show');
        }
        
        function closePendingConfirmModal() {
            document.getElementById('pendingConfirmModal').classList.remove('show');
        }
        
        function confirmPendingAction() {
            document.getElementById('pendingForm').submit();
        }

        function markAsCancelled() {
            if (currentIncidentId) {
                showCancelledConfirmModal();
            }
        }

        function showCancelledConfirmModal() {
            document.getElementById('cancelledConfirmModal').classList.add('show');
        }
        
        function closeCancelledConfirmModal() {
            document.getElementById('cancelledConfirmModal').classList.remove('show');
        }
        
        function confirmCancelledAction() {
            document.getElementById('cancelledForm').submit();
        }

        function showDispatchModal() {
            document.getElementById('dispatchModal').classList.add('show');
        }

        function closeDispatchModal() {
            document.getElementById('dispatchModal').classList.remove('show');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('show');
            clearAlertModalState();
            currentIncidentContext = null;
        }

        document.getElementById('profileButton').addEventListener('click', function() {
            document.getElementById('profileDropdown').classList.toggle('show');
        });

        window.addEventListener('click', function(event) {
            if (!event.target.closest('#profileButton') && !event.target.closest('#profileDropdown')) {
                document.getElementById('profileDropdown').classList.remove('show');
            }
            
            if (event.target === document.getElementById('alertModal')) {
                closeAlertModal();
            }
            
            if (event.target === document.getElementById('dispatchModal')) {
                closeDispatchModal();
            }
            
            if (event.target === document.getElementById('pendingConfirmModal')) {
                closePendingConfirmModal();
            }

            if (event.target === document.getElementById('resolutionSummaryModal')) {
                closeResolutionSummaryModal();
            }
        });

        // Mobile navigation toggle function
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobileNav');
            if (mobileNav) {
                mobileNav.classList.toggle('show');
                // Prevent body scroll when menu is open
                if (mobileNav.classList.contains('show')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }
        
        // Close mobile nav when clicking outside
        window.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobileNav');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            if (mobileNav && mobileNav.classList.contains('show')) {
                if (!mobileNav.contains(event.target) && event.target !== hamburgerBtn && !hamburgerBtn.contains(event.target)) {
                    toggleMobileNav();
                }
            }
        });

        function showDashboard() {
            window.location.href = '{{ url_for("dashboard") }}';
        }

        function showUserManagement() {
            window.location.href = "{{ url_for('user_management') }}";
        }

        function showIncidentManagement() {
            window.location.href = "{{ url_for('incident_management') }}";
        }

        setTimeout(() => {
            // Hide all flash messages by finding all elements with IDs starting with 'flashMessage'
            const flashMessages = document.querySelectorAll('[id^="flashMessage"]');
            flashMessages.forEach(msg => {
                if (msg) msg.style.display = 'none';
            });
        }, 5000);

    setTimeout(() => {
        const summaryCards = document.querySelectorAll('[id^="resolutionSummaryCard"]');
        summaryCards.forEach(card => {
            card.style.opacity = '0';
            setTimeout(() => {
                card.style.display = 'none';
            }, 400);
        });
    }, 12000);
        
        // ==================== OLD CHAT WIDGET FUNCTIONALITY REMOVED ====================
        // All old student-based chat functions have been removed
        // Now using incident-based chat system below
        
        // ==================== INCIDENT-BASED CHAT SYSTEM ====================
        let currentChatIncident = null;
        let incidentChatPollInterval = null;
        let incidentListPollInterval = null;
        let incidentRealtimeSubscription = null;
        
        function toggleChatWidget() {
            console.log('toggleChatWidget called');
            const chatModal = document.getElementById('chatModal');
            if (!chatModal) {
                console.error('Chat modal not found!');
                return;
            }

            if (chatModal.classList.contains('show')) {
                closeChatWidget();
            } else {
                openChatWidget();
            }
        }
        
        function openChatWidget() {
            console.log('openChatWidget called');
            const chatModal = document.getElementById('chatModal');
            if (!chatModal) {
                console.error('Chat modal not found in openChatWidget!');
                return;
            }

            chatModal.classList.add('show');
            console.log('Chat modal shown');
            showIncidentListView();
            loadIncidentList();
            startIncidentListPolling();
        }
        
        function closeChatWidget() {
            const chatModal = document.getElementById('chatModal');
            if (!chatModal) {
                return;
            }

            chatModal.classList.remove('show');
            currentChatIncident = null;
            stopIncidentChatPolling();
            stopIncidentListPolling();
            if (incidentRealtimeSubscription) {
                incidentRealtimeSubscription.unsubscribe();
                incidentRealtimeSubscription = null;
            }
        }
        
        function showIncidentListView() {
            console.log('showIncidentListView called - going back to incident list');
            const incidentListView = document.getElementById('incidentListView');
            const conversationView = document.getElementById('conversationView');
            const backBtn = document.getElementById('chatBackBtn');
            
            // Stop chat polling when going back to list
            stopIncidentChatPolling();
            currentChatIncident = null;
            
            // Switch views
            if (incidentListView) {
                incidentListView.style.display = 'block';
            }
            if (conversationView) {
                conversationView.style.display = 'none';
            }
            if (backBtn) {
                backBtn.style.display = 'none';
            }
            
            // Reload incident list to get latest data
            loadIncidentList();
            startIncidentListPolling();
        }
        
        function showIncidentConversation(incidentId, studentName = null) {
            const incidentListView = document.getElementById('incidentListView');
            const conversationView = document.getElementById('conversationView');
            const backBtn = document.getElementById('chatBackBtn');
            const titleEl = document.getElementById('chatHeaderTitle');
            
            if (incidentListView) incidentListView.style.display = 'none';
            if (conversationView) conversationView.style.display = 'flex';
            if (backBtn) backBtn.style.display = 'flex';
            
            // Update title with student name if provided
            if (titleEl && studentName) {
                titleEl.textContent = `Chat: ${studentName}`;
            } else if (titleEl) {
                titleEl.textContent = `Incident: ${incidentId}`;
            }
            
            currentChatIncident = incidentId;
            loadIncidentChat(incidentId);
            startIncidentChatPolling(incidentId);
        }
        
        // Function to start chat with a student (opens chat modal and navigates to incident conversation)
        function startChatWithStudent(userId, studentName, incidentId) {
            console.log('startChatWithStudent called:', { userId, studentName, incidentId });
            
            // Ensure chat modal exists
            const chatModal = document.getElementById('chatModal');
            if (!chatModal) {
                console.error('Chat modal not found!');
                alert('Chat modal not available. Please refresh the page.');
                return;
            }
            
            // Normalize incident ID (handle both "ICD00110" and "00110" formats)
            let incidentIdStr = String(incidentId).trim();
            // If it doesn't start with "ICD", try to add it
            if (!incidentIdStr.toUpperCase().startsWith('ICD')) {
                // Check if it's just a number, then add ICD prefix
                if (/^\d+$/.test(incidentIdStr)) {
                    incidentIdStr = 'ICD' + incidentIdStr.padStart(5, '0');
                } else {
                    incidentIdStr = 'ICD' + incidentIdStr;
                }
            }
            
            console.log('Normalized incident ID:', incidentIdStr);
            
            // Open the chat modal
            chatModal.classList.add('show');
            
            // Ensure modal is visible and then navigate to conversation
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(() => {
                // Navigate directly to the incident conversation (skip incident list)
                showIncidentConversation(incidentIdStr, studentName);
                
                // Scroll to top of messages if needed
                setTimeout(() => {
                    const messagesContainer = document.getElementById('chatMessages');
                    if (messagesContainer) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }, 200);
            });
        }
        
        function loadIncidentList() {
            const container = document.getElementById('incidentListContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="chat-loading"><div class="spinner"></div><p>Loading incidents...</p></div>';
            
            fetch('/api/chat/incidents')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayIncidentList(data.incidents);
                        } else {
                        container.innerHTML = `<div class="text-center text-red-500 py-4">${data.message || 'Error loading incidents'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading incidents:', error);
                    container.innerHTML = '<div class="text-center text-red-500 py-4">Network error. Please try again.</div>';
                });
        }
        
        function displayIncidentList(incidents) {
            const container = document.getElementById('incidentListContainer');
            if (!container) return;
            
            if (incidents.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No incidents assigned to you</div>';
                return;
            }
            
            container.innerHTML = incidents.map(incident => {
                const timestamp = new Date(incident.icd_timestamp);
                const timeStr = timestamp.toLocaleString();
                const unreadBadge = incident.has_unread ? `<span class="unread-badge">${incident.unread_count > 99 ? '99+' : incident.unread_count}</span>` : '';
                
                return `
                    <div class="incident-item" onclick="showIncidentConversation('${incident.icd_id}')">
                        <div class="incident-item-header">
                            <span class="incident-id">ICD_${incident.icd_id}</span>
                            <span class="incident-status status-${incident.icd_status.toLowerCase()}">${incident.icd_status}</span>
                            ${unreadBadge}
                        </div>
                        <div class="incident-student">${incident.full_name}</div>
                        <div class="incident-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }
        
        function loadIncidentChat(incidentId) {
            const messagesContainer = document.getElementById('chatMessages');
            const titleEl = document.getElementById('chatHeaderTitle');
            
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '<div class="chat-loading"><div class="spinner"></div><p>Loading messages...</p></div>';
            
            fetch(`/api/chat/incident/${incidentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (titleEl && data.student_name) {
                            titleEl.textContent = `Chat - ${data.student_name} (ICD_${incidentId})`;
                        }
                        displayIncidentMessages(data.messages);
                        scrollToBottom();
                    } else {
                        messagesContainer.innerHTML = `<div class="text-center text-red-500 py-4">${data.message || 'Error loading messages'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading chat:', error);
                    messagesContainer.innerHTML = '<div class="text-center text-red-500 py-4">Network error. Please try again.</div>';
                });
        }
        
        function displayIncidentMessages(messages) {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No messages yet. Start the conversation!</div>';
                return;
            }
            
            const adminId = '{{ session.get("admin_id", "") }}';
            
            messagesContainer.innerHTML = messages.map(msg => {
                const isAdmin = msg.sender_type === 'admin' && msg.sender_id === adminId;
                const timestamp = new Date(msg.timestamp || msg.created_at);
                const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let messageContent = '';
                if (msg.image_url) {
                    messageContent = `<img src="/static/images/${msg.image_url}" alt="Image" class="chat-image" onclick="openImageModal('/static/images/${msg.image_url}')">`;
                }
                if (msg.message) {
                    messageContent += `<div class="message-text">${escapeHtml(msg.message)}</div>`;
                }
                
                return `
                    <div class="message ${isAdmin ? 'message-sent' : 'message-received'}">
                        <div class="message-content">
                            ${messageContent}
                        </div>
                        <div class="message-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }
        
        function sendIncidentMessage() {
            if (!currentChatIncident) {
                alert('No incident selected');
                return;
            }
            
            const input = document.getElementById('chatInput');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            
            if (!input) return;
            
            const message = input.value.trim();
            const hasImage = previewImage && previewImage.src && !previewImage.src.includes('data:image/svg');
            
            if (!message && !hasImage) {
                    return;
                }
                
            // Get student_id from current incident
            fetch(`/api/chat/incident/${currentChatIncident}`)
                    .then(response => response.json())
                    .then(data => {
                    if (!data.success || !data.incident) {
                        alert('Error: Could not get incident details');
                return;
            }
            
                    const studentId = data.incident.user_id;
                    if (!studentId) {
                        alert('Error: Student ID not found');
                return;
            }
            
                    const messageData = {
                        incident_id: currentChatIncident,
                        student_id: studentId,
                        message: message
                    };
                    
                    if (hasImage) {
                        const canvas = document.createElement('canvas');
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = function() {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            const base64 = canvas.toDataURL('image/jpeg', 0.8);
                            messageData.image = base64;
                            messageData.image_name = 'image.jpg';
                            messageData.image_type = 'image/jpeg';
                            sendMessageRequest(messageData, input, imagePreview);
                        };
                        img.src = previewImage.src;
                    } else {
                        sendMessageRequest(messageData, input, imagePreview);
                    }
                })
                .catch(error => {
                    console.error('Error getting incident details:', error);
                    alert('Error: Could not get incident details');
                });
        }
        
        function sendMessageRequest(messageData, input, imagePreview) {
            fetch('/api/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageData)
            })
            .then(response => response.json())
                .then(data => {
                    if (data.success) {
                    input.value = '';
                    if (imagePreview) {
                        imagePreview.style.display = 'none';
                        if (document.getElementById('previewImage')) {
                            document.getElementById('previewImage').src = '';
                        }
                    }
                    if (document.getElementById('imageInput')) {
                        document.getElementById('imageInput').value = '';
                    }
                    // Reload messages
                    if (currentChatIncident) {
                        loadIncidentChat(currentChatIncident);
                    }
                } else {
                    alert(data.message || 'Failed to send message');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Network error. Please try again.');
            });
        }
        
        function startIncidentListPolling() {
            stopIncidentListPolling();
            incidentListPollInterval = setInterval(() => {
                loadIncidentList();
            }, 30000); // Poll every 30 seconds
        }
        
        function stopIncidentListPolling() {
            if (incidentListPollInterval) {
                clearInterval(incidentListPollInterval);
                incidentListPollInterval = null;
            }
        }
        
        function startIncidentChatPolling(incidentId) {
            stopIncidentChatPolling();
            incidentChatPollInterval = setInterval(() => {
                if (currentChatIncident === incidentId) {
                    loadIncidentChat(incidentId);
                }
            }, 5000); // Poll every 5 seconds
        }
        
        function stopIncidentChatPolling() {
            if (incidentChatPollInterval) {
                clearInterval(incidentChatPollInterval);
                incidentChatPollInterval = null;
            }
        }
        
        function updateChatNotification(count) {
            const chatButton = document.getElementById('chatButton');
            const notificationDot = document.getElementById('chatNotificationDot');
            
            if (chatButton && notificationDot) {
                if (count > 0) {
                    chatButton.classList.add('has-notifications');
                    notificationDot.textContent = count > 99 ? '99+' : count;
                    notificationDot.style.display = 'flex';
                            } else {
                    chatButton.classList.remove('has-notifications');
                    notificationDot.style.display = 'none';
                }
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            if (modal && modalImage) {
                modalImage.src = imageSrc;
                modal.style.display = 'flex';
            }
        }
        
        function closeImageModal(event) {
            const modal = document.getElementById('imageModal');
            if (modal && (!event || event.target === modal)) {
                modal.style.display = 'none';
            }
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const previewImage = document.getElementById('previewImage');
                if (preview && previewImage) {
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }

        function removeImagePreview() {
            const preview = document.getElementById('imagePreview');
            const imageInput = document.getElementById('imageInput');
            if (preview) preview.style.display = 'none';
            if (imageInput) imageInput.value = '';
        }
        
        // Update unread count on page load and periodically
        function updateUnreadCount() {
            fetch('/api/chat/unread-count')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateChatNotification(data.unread_count || 0);
                    }
                })
                .catch(error => {
                    console.error('Error checking unread count:', error);
                });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateUnreadCount();
            setInterval(updateUnreadCount, 60000); // Update every minute
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendIncidentMessage();
                    }
                });
                
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                });
            }
        });
        
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        }
        
        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendIncidentMessage();
                    }
                });
                
                // Auto-resize textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                });
            }
        });
        
        // Close chat when clicking outside
        document.addEventListener('click', function(event) {
            const chatWidget = document.querySelector('.chat-widget');
            const chatModal = document.getElementById('chatModal');
            const chatButton = document.getElementById('chatButton');
            
            // Don't close if clicking the chat button
            if (chatButton && chatButton.contains(event.target)) {
                return;
            }
            
            if (chatModal && chatModal.classList.contains('show') && 
                chatWidget && !chatWidget.contains(event.target)) {
                closeChatWidget();
            }
        });
        
        // Make functions globally accessible
        window.toggleChatWidget = toggleChatWidget;
        window.openChatWidget = openChatWidget;
        window.closeChatWidget = closeChatWidget;
        window.showIncidentListView = showIncidentListView;
        window.showIncidentConversation = showIncidentConversation;
        window.sendIncidentMessage = sendIncidentMessage;
        window.handleImageSelect = handleImageSelect;
        window.removeImagePreview = removeImagePreview;
        window.openImageModal = openImageModal;
        window.closeImageModal = closeImageModal;
        window.startChatWithStudent = startChatWithStudent;
        
        // Add event listener to chat button when DOM is ready
        function initializeChatButton() {
            const chatButton = document.getElementById('chatButton');
            if (chatButton) {
                console.log('Chat button found, initializing...');
                // Remove inline onclick and use event listener instead
                chatButton.removeAttribute('onclick');
                
                // Remove any existing listeners by cloning
                const newButton = chatButton.cloneNode(true);
                chatButton.parentNode.replaceChild(newButton, chatButton);
                
                // Add click event listener
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Chat button clicked!');
                    toggleChatWidget();
                });
                
                // Ensure button is clickable
                newButton.style.pointerEvents = 'auto';
                newButton.style.cursor = 'pointer';
                newButton.style.zIndex = '99999';
                
                console.log('Chat button initialized successfully');
            } else {
                console.error('Chat button element not found!');
                // Retry after a short delay
                setTimeout(initializeChatButton, 500);
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChatButton);
        } else {
            // DOM already loaded
            initializeChatButton();
        }
    </script>

    <!-- Floating Chat Button -->
    <div id="chatButton" class="chat-button" title="Chat with Students">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4v3c0 .6.4 1 1 1 .2 0 .5-.1.7-.3L15.4 18H20c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H15l-4 3v-3H4V4h16v12z"/>
        </svg>
        <span class="chat-button-text">Messages</span>
        <div id="chatNotificationDot" class="notification-dot" style="display: none;">0</div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal(event)">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <button class="image-modal-close" onclick="closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Full size image">
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-widget">
            <div class="chat-header">
                <h3 class="chat-header-title">Incident Chat</h3>
                <button class="close-btn" onclick="closeChatWidget()">×</button>
            </div>
            
            <div class="chat-content">
                <!-- Incident List View -->
                <div id="incidentListView" class="incident-list">
                    <div id="incidentListContainer" class="incident-list-container">
                        <div class="chat-loading">
                            <div class="spinner"></div>
                            <p>Loading incidents...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Conversation View -->
                <div id="conversationView" class="chat-thread" style="display: none;">
                    <div class="chat-thread-header">
                        <button id="chatBackBtn" class="back-btn" onclick="showIncidentListView()" style="display: none;">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <h4 id="chatHeaderTitle">Select an incident</h4>
                    </div>
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <button id="imageButton" class="image-btn" onclick="document.getElementById('imageInput').click()" title="Send image">
                            <i class="fas fa-image"></i>
                        </button>
                        <textarea id="chatInput" placeholder="Type your message..." rows="1"></textarea>
                        <button id="sendButton" onclick="sendIncidentMessage()">Send</button>
                    </div>
                    <div id="imagePreview" class="image-preview" style="display: none;">
                        <img id="previewImage" src="" alt="Preview">
                        <button class="remove-image-btn" onclick="removeImagePreview()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Floating Chat Button Styles */
        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            min-width: 60px;
            height: 60px;
            padding: 0 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            z-index: 99999;
            transition: all 0.3s ease;
            border: none;
            pointer-events: auto;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .chat-button-text {
            color: white;
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
        }
        
        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }
        
        .chat-button.has-notifications {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }
            100% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); }
        }
        
        .notification-dot {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
        }
        
        /* Incident List Styles */
        .incident-list {
            height: 100%;
            overflow-y: auto;
        }
        
        .incident-list-container {
            padding: 10px;
        }
        
        .incident-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid #667eea;
            position: relative;
        }
        
        .incident-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .incident-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .incident-id {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .incident-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-resolved { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .incident-student {
            color: #666;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .incident-time {
            color: #999;
            font-size: 11px;
        }
        
        .unread-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .chat-header-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        /* Chat Modal Styles */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }
        
        .chat-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-widget {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-header-tabs {
            display: flex;
            gap: 8px;
            flex: 1;
        }
        
        .tab-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tab-btn.active {
            background: white;
            color: #667eea;
        }
        
        .chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        
        .inbox-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            min-height: 0;
        }
        
        .inbox-container {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .inbox-message-item {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: relative;
        }
        
        .inbox-message-item:hover {
            background: #f8f9ff;
        }
        
        .inbox-message-item.unread {
            background: #f0f4ff;
            border-left: 3px solid #667eea;
        }
        
        .inbox-message-item.unread:hover {
            background: #e8edff;
        }
        
        .message-avatar-inbox {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .message-content-inbox {
            flex: 1;
            min-width: 0;
        }
        
        .message-header-inbox {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .message-student-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        
        .message-time-inbox {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }
        
        .message-snippet {
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .message-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-new {
            background: #dc2626;
            color: white;
        }
        
        .status-read {
            background: #6b7280;
            color: white;
        }
        
        .status-responded {
            background: #10b981;
            color: white;
        }
        
        .status-sos {
            background: #ef4444;
            color: white;
            animation: pulse-sos 2s infinite;
        }
        
        @keyframes pulse-sos {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .chat-student-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .chat-student-btn:hover {
            background: #5568d3;
        }
        
        .student-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            min-height: 0;
        }
        
        .students-container {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Custom scrollbar styling for student list */
        .student-list::-webkit-scrollbar,
        .students-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .student-list::-webkit-scrollbar-track,
        .students-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .student-list::-webkit-scrollbar-thumb,
        .students-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .student-list::-webkit-scrollbar-thumb:hover,
        .students-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .chat-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chat-student-item {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-student-item:hover {
            background: #f8f9ff;
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .student-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .student-details {
            flex: 1;
        }
        
        .student-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .student-id {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .last-message {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .conversation-preview {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        .chat-thread {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }
        
        .chat-thread-header {
            background: #f8f9ff;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
            background: #fafafa;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Custom scrollbar styling for chat messages */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .chat-messages:empty::before {
            content: 'No messages yet. Start the conversation!';
            display: block;
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        
        .message-date-separator {
            text-align: center;
            margin: 16px 0;
            position: relative;
        }
        
        .message-date-separator::before,
        .message-date-separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e5e7eb;
        }
        
        .message-date-separator::before {
            left: 0;
        }
        
        .message-date-separator::after {
            right: 0;
        }
        
        .message-date-separator span {
            background: white;
            padding: 4px 12px;
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            margin-bottom: 12px;
            word-wrap: break-word;
        }
        
        .message-sent {
            align-self: flex-end;
            align-items: flex-end;
        }
        
        .message-received {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        .message-content {
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .message-sent .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .message-received .message-content {
            background: #f1f3f4;
            color: #333;
            border-bottom-left-radius: 6px;
        }
        
        .message-text {
            margin: 0;
            line-height: 1.4;
        }
        
        .chat-image {
            max-width: 250px;
            max-height: 250px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 4px;
            display: block;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }
        
        .message-sent .message-time {
            text-align: right;
        }
        
        .message-received .message-time {
            text-align: left;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .message.received .message-avatar {
            background: #e0e0e0;
            color: #333;
        }
        
        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            max-width: 100%;
        }
        
        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .message.received .message-bubble {
            background: #f1f3f4;
            color: #333;
            border-bottom-left-radius: 6px;
        }
        
        /* Student message styling - different color to distinguish from admin */
        .message.student-message .message-bubble {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-bottom-left-radius: 6px;
        }
        
        .message.student-message .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .message-time-small {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
            text-align: right;
            padding: 0 4px;
        }
        
        .message.received .message-time-small {
            text-align: left;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }
        
        .message.received .message-time {
            text-align: left;
        }
        
        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: white;
        }
        
        .image-btn {
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #667eea;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .image-btn:hover {
            background: #e0e0e0;
            transform: scale(1.1);
        }
        
        .image-preview {
            padding: 12px 16px;
            border-top: 1px solid #eee;
            background: #f9f9f9;
            position: relative;
        }
        
        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            display: block;
        }
        
        .remove-image-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-image-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .message-image-container {
            margin-bottom: 4px;
        }
        
        .message-image {
            max-width: 250px;
            max-height: 250px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: block;
        }
        
        .message-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .back-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .back-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #764ba2;
        }
        
        .chat-thread-header {
            background: #f8f9ff;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-thread-header h4 {
            margin: 0;
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        #chatInput {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 14px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        #chatInput:focus {
            border-color: #667eea;
        }
        
        #sendButton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        #sendButton:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        #sendButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal.show {
            display: flex;
        }
        
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .image-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }
        
        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }
        
        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .chat-widget {
                width: 95%;
                height: 90%;
            }
            
        }
    </style>
</body>
</html>